

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Inelastica.NEGF &mdash; Inelastica v1.3.6 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Inelastica
          

          
            
            <img src="../../_static/82px-Inelastica-logo-mini.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                v1.3.6
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scripts.html">Scripts</a></li>
</ul>
<p class="caption"><span class="caption-text">Publications</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../cite.html">Citing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../publications.html">Publications using Inelastica</a></li>
</ul>
<p class="caption"><span class="caption-text">API documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api-gen/Inelastica.html">Inelastica package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Inelastica</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>Inelastica.NEGF</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for Inelastica.NEGF</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">:mod:`Inelastica.NEGF`</span>
<span class="sd">======================</span>

<span class="sd">Non-Equilibrium Green&#39;s function</span>

<span class="sd">.. currentmodule:: Inelastica.NEGF</span>

<span class="sd">Classes</span>
<span class="sd">-------</span>

<span class="sd">.. autosummary::</span>
<span class="sd">   :toctree:</span>

<span class="sd">   SigDir</span>
<span class="sd">   SavedSigClass</span>
<span class="sd">   ElectrodeSelfEnergy</span>
<span class="sd">   GF</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">N</span>
<span class="kn">import</span> <span class="nn">numpy.linalg</span> <span class="kn">as</span> <span class="nn">LA</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">netCDF4</span> <span class="kn">as</span> <span class="nn">NC4</span>
<span class="kn">import</span> <span class="nn">Inelastica.misc.valuecheck</span> <span class="kn">as</span> <span class="nn">VC</span>
<span class="kn">import</span> <span class="nn">Inelastica.io.siesta</span> <span class="kn">as</span> <span class="nn">SIO</span>
<span class="kn">import</span> <span class="nn">Inelastica.math</span> <span class="kn">as</span> <span class="nn">MM</span>

<span class="c1"># For speed some routines can be linked as F90 code</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">Inelastica.fortran.F90_lapack</span> <span class="kn">as</span> <span class="nn">F90</span>
    <span class="n">F90_lapack_imp</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">F90_lapack_imp</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;########################################################&quot;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Problems encountered with F90_lapack.so&quot;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;The linking/finding of LAPACK routines does not work&quot;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Ensure the placement of LAPACK in your LD_LIBRARY_PATH&quot;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Try compiling manually following these steps:&quot;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot; $ cd Inelastica/fortran&quot;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot; $ source compile.bat (or compile_alternative.bat)&quot;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot; $ cp F90_lapack.so &lt;python&gt;/site-packages/Inelastica/fortran/&quot;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;########################################################&quot;</span><span class="p">)</span>

<span class="c1">#try:</span>
<span class="c1">#    import scipy.linalg as SLA</span>
<span class="c1">#    hasSciPy = True</span>
<span class="c1">#except:</span>
<span class="c1">#    hasSciPy = False</span>

<span class="c1">########################################################</span>


<div class="viewcode-block" id="AssertReal"><a class="viewcode-back" href="../../api-gen/Inelastica.NEGF.html#Inelastica.NEGF.AssertReal">[docs]</a><span class="k">def</span> <span class="nf">AssertReal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="n">VC</span><span class="o">.</span><span class="n">Check</span><span class="p">(</span><span class="s2">&quot;zero-imaginary-part&quot;</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">imag</span><span class="p">),</span>
             <span class="s2">&quot;Imaginary part too large in quantity </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">label</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">real</span></div>


<div class="viewcode-block" id="myHash"><a class="viewcode-back" href="../../api-gen/Inelastica.NEGF.html#Inelastica.NEGF.myHash">[docs]</a><span class="k">def</span> <span class="nf">myHash</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span></div>


<div class="viewcode-block" id="hash2dec"><a class="viewcode-back" href="../../api-gen/Inelastica.NEGF.html#Inelastica.NEGF.hash2dec">[docs]</a><span class="k">def</span> <span class="nf">hash2dec</span><span class="p">(</span><span class="nb">hash</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">hash</span><span class="p">]</span></div>


<div class="viewcode-block" id="dec2hash"><a class="viewcode-back" href="../../api-gen/Inelastica.NEGF.html#Inelastica.NEGF.dec2hash">[docs]</a><span class="k">def</span> <span class="nf">dec2hash</span><span class="p">(</span><span class="n">dec</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dec</span><span class="p">)):</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">dec</span><span class="p">[</span><span class="n">ii</span><span class="p">])[</span><span class="mi">2</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">s</span></div>


<div class="viewcode-block" id="SigDir"><a class="viewcode-back" href="../../api-gen/Inelastica.NEGF.html#Inelastica.NEGF.SigDir">[docs]</a><span class="k">class</span> <span class="nc">SigDir</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">path</span><span class="p">,</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">newFile</span> <span class="o">=</span> <span class="p">[],</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/Sig*.nc&#39;</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>

<div class="viewcode-block" id="SigDir.add"><a class="viewcode-back" href="../../api-gen/Inelastica.NEGF.html#Inelastica.NEGF.SigDir.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="n">ncfile</span> <span class="o">=</span> <span class="n">NC4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;Done&#39;</span> <span class="ow">in</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Read &quot;</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
            <span class="n">ncv</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span>
            <span class="n">hash1</span><span class="p">,</span> <span class="n">hash2l</span><span class="p">,</span> <span class="n">reE</span><span class="p">,</span> <span class="n">imE</span><span class="p">,</span> <span class="n">LR</span><span class="p">,</span> <span class="n">ispin</span><span class="p">,</span> <span class="n">etaLead</span> <span class="o">=</span> <span class="n">ncv</span><span class="p">[</span><span class="s1">&#39;hash&#39;</span><span class="p">][:],</span> <span class="n">ncv</span><span class="p">[</span><span class="s1">&#39;hash2&#39;</span><span class="p">][:],</span> <span class="n">ncv</span><span class="p">[</span><span class="s1">&#39;reE&#39;</span><span class="p">][:],</span> <span class="n">ncv</span><span class="p">[</span><span class="s1">&#39;imE&#39;</span><span class="p">][:],</span> <span class="n">ncv</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">][:],</span> <span class="n">ncv</span><span class="p">[</span><span class="s1">&#39;ispin&#39;</span><span class="p">][:],</span> <span class="n">ncv</span><span class="p">[</span><span class="s1">&#39;etaLead&#39;</span><span class="p">][:]</span>
            <span class="n">hash1</span> <span class="o">=</span> <span class="p">[</span><span class="n">dec2hash</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">hash1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reE</span><span class="p">)):</span>
                <span class="n">hash2</span> <span class="o">=</span> <span class="n">dec2hash</span><span class="p">(</span><span class="n">hash2l</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Found &quot;</span><span class="p">,</span> <span class="n">hash2</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">hash2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ncfile</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ncfile</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ncfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="SigDir.getSig"><a class="viewcode-back" href="../../api-gen/Inelastica.NEGF.html#Inelastica.NEGF.SigDir.getSig">[docs]</a>    <span class="k">def</span> <span class="nf">getSig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">hash</span><span class="p">,</span> <span class="n">ee</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">ispin</span><span class="p">,</span> <span class="n">etaLead</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">left</span><span class="p">:</span>
            <span class="n">left</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">left</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">hash2</span> <span class="o">=</span> <span class="n">myHash</span><span class="p">([</span><span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">hash</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">real</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">imag</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">kp</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">left</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ispin</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">etaLead</span><span class="p">)])</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Get &quot;</span><span class="p">,</span> <span class="n">hash2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hash2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Found&quot;</span><span class="p">)</span>
            <span class="n">ncf</span><span class="p">,</span> <span class="n">ii</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">hash2</span><span class="p">]</span>
            <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="n">ncf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;reSig&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">+</span><span class="mi">1j</span><span class="o">*</span><span class="n">ncf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;imSig&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span></div>

<div class="viewcode-block" id="SigDir.addSig"><a class="viewcode-back" href="../../api-gen/Inelastica.NEGF.html#Inelastica.NEGF.SigDir.addSig">[docs]</a>    <span class="k">def</span> <span class="nf">addSig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">hash</span><span class="p">,</span> <span class="n">ee</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">ispin</span><span class="p">,</span> <span class="n">etaLead</span><span class="p">,</span> <span class="n">Sig</span><span class="p">):</span>
        <span class="c1">#print &quot;Add &quot;,hash,ee,kp,left,ispin,etaLead,Sig</span>
        <span class="k">if</span> <span class="n">left</span><span class="p">:</span>
            <span class="n">left</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">left</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">newFile</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">newFileIndx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">nf</span> <span class="o">=</span> <span class="n">NC4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/Sig_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span><span class="o">*</span><span class="mf">1e9</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">nf</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;One&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">nf</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;Two&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">nf</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;32&#39;</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
            <span class="n">nf</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;Dim&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">Sig</span><span class="p">))</span>
            <span class="n">nf</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;List&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">nf</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;kp&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;List&#39;</span><span class="p">,</span> <span class="s1">&#39;Two&#39;</span><span class="p">))</span>
            <span class="n">nf</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;reE&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;List&#39;</span><span class="p">,))</span>
            <span class="n">nf</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;imE&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;List&#39;</span><span class="p">,))</span>
            <span class="n">nf</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;List&#39;</span><span class="p">,))</span>
            <span class="n">nf</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;hash&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;List&#39;</span><span class="p">,</span> <span class="s1">&#39;32&#39;</span><span class="p">))</span>
            <span class="n">nf</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;hash2&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;List&#39;</span><span class="p">,</span> <span class="s1">&#39;32&#39;</span><span class="p">))</span>
            <span class="n">nf</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;ispin&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;List&#39;</span><span class="p">,))</span>
            <span class="n">nf</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;etaLead&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;List&#39;</span><span class="p">,))</span>
            <span class="n">nf</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;reSig&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;List&#39;</span><span class="p">,</span> <span class="s1">&#39;Dim&#39;</span><span class="p">,</span> <span class="s1">&#39;Dim&#39;</span><span class="p">))</span>
            <span class="n">nf</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;imSig&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;List&#39;</span><span class="p">,</span> <span class="s1">&#39;Dim&#39;</span><span class="p">,</span> <span class="s1">&#39;Dim&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">newFile</span> <span class="o">=</span> <span class="n">nf</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">+=</span> <span class="p">[</span><span class="n">nf</span><span class="p">]</span>
        <span class="n">NN</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newFileIndx</span>
        <span class="n">hash2</span> <span class="o">=</span> <span class="n">myHash</span><span class="p">([</span><span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">hash</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">real</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">imag</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">kp</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">left</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ispin</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">etaLead</span><span class="p">)])</span>
        <span class="n">nfv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newFile</span><span class="o">.</span><span class="n">variables</span>
        <span class="n">nfv</span><span class="p">[</span><span class="s1">&#39;hash&#39;</span><span class="p">][</span><span class="n">NN</span><span class="p">,</span> <span class="p">:],</span> <span class="n">nfv</span><span class="p">[</span><span class="s1">&#39;reE&#39;</span><span class="p">][</span><span class="n">NN</span><span class="p">],</span> <span class="n">nfv</span><span class="p">[</span><span class="s1">&#39;imE&#39;</span><span class="p">][</span><span class="n">NN</span><span class="p">]</span> <span class="o">=</span> <span class="n">hash2dec</span><span class="p">(</span><span class="nb">hash</span><span class="p">),</span> <span class="n">ee</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">imag</span>
        <span class="n">nfv</span><span class="p">[</span><span class="s1">&#39;hash2&#39;</span><span class="p">][</span><span class="n">NN</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">hash2dec</span><span class="p">(</span><span class="n">hash2</span><span class="p">)</span>
        <span class="n">nfv</span><span class="p">[</span><span class="s1">&#39;kp&#39;</span><span class="p">][</span><span class="n">NN</span><span class="p">,</span> <span class="p">:],</span> <span class="n">nfv</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">][</span><span class="n">NN</span><span class="p">],</span> <span class="n">nfv</span><span class="p">[</span><span class="s1">&#39;ispin&#39;</span><span class="p">][</span><span class="n">NN</span><span class="p">],</span> <span class="n">nfv</span><span class="p">[</span><span class="s1">&#39;etaLead&#39;</span><span class="p">][</span><span class="n">NN</span><span class="p">]</span> <span class="o">=</span> <span class="n">kp</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">ispin</span><span class="p">,</span> <span class="n">etaLead</span>
        <span class="n">nfv</span><span class="p">[</span><span class="s1">&#39;reSig&#39;</span><span class="p">][</span><span class="n">NN</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">nfv</span><span class="p">[</span><span class="s1">&#39;imSig&#39;</span><span class="p">][</span><span class="n">NN</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">Sig</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">Sig</span><span class="o">.</span><span class="n">imag</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Put &quot;</span><span class="p">,</span> <span class="n">hash2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">hash2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">newFile</span><span class="p">,</span> <span class="n">NN</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newFileIndx</span> <span class="o">+=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="SigDir.close"><a class="viewcode-back" href="../../api-gen/Inelastica.NEGF.html#Inelastica.NEGF.SigDir.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">newFile</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">newFile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;Done&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;One&#39;</span><span class="p">,))</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="SavedSigClass"><a class="viewcode-back" href="../../api-gen/Inelastica.NEGF.html#Inelastica.NEGF.SavedSigClass">[docs]</a><span class="k">class</span> <span class="nc">SavedSigClass</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Saves calculated Sig in files in the directory of the TSHS file for the electrode.</span>
<span class="sd">    1: Each process opens a new file if it needs to write Sigma</span>
<span class="sd">    2: The file cannot be read before the finished flag is set</span>
<span class="sd">    3: The integrity of the data is maintained by a hash of HS, NA1, NA2, voltage</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigs</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="SavedSigClass.add_hsfile"><a class="viewcode-back" href="../../api-gen/Inelastica.NEGF.html#Inelastica.NEGF.SavedSigClass.add_hsfile">[docs]</a>    <span class="k">def</span> <span class="nf">add_hsfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sigs</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">SigDir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="SavedSigClass.getSig"><a class="viewcode-back" href="../../api-gen/Inelastica.NEGF.html#Inelastica.NEGF.SavedSigClass.getSig">[docs]</a>    <span class="k">def</span> <span class="nf">getSig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="nb">hash</span><span class="p">,</span> <span class="n">ee</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">ispin</span><span class="p">,</span> <span class="n">etaLead</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigs</span><span class="p">[</span><span class="n">path</span><span class="p">]</span><span class="o">.</span><span class="n">getSig</span><span class="p">(</span><span class="nb">hash</span><span class="p">,</span> <span class="n">ee</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">ispin</span><span class="p">,</span> <span class="n">etaLead</span><span class="p">)</span></div>

<div class="viewcode-block" id="SavedSigClass.addSig"><a class="viewcode-back" href="../../api-gen/Inelastica.NEGF.html#Inelastica.NEGF.SavedSigClass.addSig">[docs]</a>    <span class="k">def</span> <span class="nf">addSig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="nb">hash</span><span class="p">,</span> <span class="n">ee</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">ispin</span><span class="p">,</span> <span class="n">etaLead</span><span class="p">,</span> <span class="n">Sig</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigs</span><span class="p">[</span><span class="n">path</span><span class="p">]</span><span class="o">.</span><span class="n">addSig</span><span class="p">(</span><span class="nb">hash</span><span class="p">,</span> <span class="n">ee</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">ispin</span><span class="p">,</span> <span class="n">etaLead</span><span class="p">,</span> <span class="n">Sig</span><span class="p">)</span></div>

<div class="viewcode-block" id="SavedSigClass.close"><a class="viewcode-back" href="../../api-gen/Inelastica.NEGF.html#Inelastica.NEGF.SavedSigClass.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigs</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigs</span> <span class="o">=</span> <span class="p">{}</span></div></div>

<span class="k">global</span> <span class="n">SavedSig</span>
<span class="n">SavedSig</span> <span class="o">=</span> <span class="n">SavedSigClass</span><span class="p">()</span>


<div class="viewcode-block" id="ElectrodeSelfEnergy"><a class="viewcode-back" href="../../api-gen/Inelastica.NEGF.html#Inelastica.NEGF.ElectrodeSelfEnergy">[docs]</a><span class="k">class</span> <span class="nc">ElectrodeSelfEnergy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate surface Greens function and self energy</span>
<span class="sd">    (should probably be renamed selfEnergy ...)</span>
<span class="sd">    For spinpolarized use the ispin given, for nonpolarized use</span>
<span class="sd">    the same self-energy for both spin</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">SavedSig</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">NA1</span><span class="p">,</span> <span class="n">NA2</span><span class="p">,</span> <span class="n">voltage</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">UseF90helpers</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">fn</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HS</span> <span class="o">=</span> <span class="n">SIO</span><span class="o">.</span><span class="n">HS</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">UseF90helpers</span><span class="o">=</span><span class="n">UseF90helpers</span><span class="p">)</span> <span class="c1"># An electrode HS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hash</span> <span class="o">=</span> <span class="n">myHash</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="p">,</span> <span class="n">NA1</span><span class="p">,</span> <span class="n">NA2</span><span class="p">,</span> <span class="n">voltage</span><span class="p">])</span>
        <span class="n">SavedSig</span><span class="o">.</span><span class="n">add_hsfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">gamma</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Are you trying to sneak a Gamma point electrode calculation past me?&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NA1</span> <span class="o">=</span> <span class="n">NA1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NA2</span> <span class="o">=</span> <span class="n">NA2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kpoint</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1e10</span><span class="p">,</span> <span class="mf">1e10</span><span class="p">],</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">voltage</span> <span class="o">=</span> <span class="n">voltage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaling</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c1"># Default scale factor for coupling to device</span>

<div class="viewcode-block" id="ElectrodeSelfEnergy.getSig"><a class="viewcode-back" href="../../api-gen/Inelastica.NEGF.html#Inelastica.NEGF.ElectrodeSelfEnergy.getSig">[docs]</a>    <span class="k">def</span> <span class="nf">getSig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ee</span><span class="p">,</span> <span class="n">qp</span><span class="o">=</span><span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">),</span> <span class="n">left</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">Bulk</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ispin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">UseF90helpers</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">etaLead</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">useSigNCfiles</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get self-energy for specified 2-D surface k-point</span>
<span class="sd">        Copy out g0 (surface greens function for smaller electrode calculation)</span>
<span class="sd">        onto NA1*NA2*nuo matrix with the idiotic (TS) orbital order</span>
<span class="sd">        a1(0,0) a1(1,0) .. a1(0,1) a1(1,1) ...... a2(0,0)</span>
<span class="sd">        Where a1, a2 ... are the atoms in the electrode calculation</span>
<span class="sd">        and (0,0) (1,0) indicate the replicating position.</span>

<span class="sd">        This gives self-energy from the solution of:</span>
<span class="sd">        Gs = (E S - H -Sigma)^-1 for Sigma</span>

<span class="sd">        For Bulk = True: Return E S - H - Sig (which we substitute into the bigger H)</span>
<span class="sd">        The voltage is assumed to be applied symmetrically and just shifts the energies of the self-energy</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">eeshifted</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">voltage</span> <span class="c1"># Shift of self energies due to voltage</span>

        <span class="k">if</span> <span class="n">useSigNCfiles</span><span class="p">:</span>
            <span class="n">Found</span><span class="p">,</span> <span class="n">Sig</span> <span class="o">=</span> <span class="n">SavedSig</span><span class="o">.</span><span class="n">getSig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">,</span> <span class="n">eeshifted</span><span class="p">,</span> <span class="n">qp</span><span class="p">,</span> <span class="n">left</span><span class="o">*</span><span class="mi">1</span><span class="p">,</span> <span class="n">ispin</span><span class="p">,</span> <span class="n">etaLead</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">Found</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaling</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;NEGF.getSig: Scaling self-energy with a factor&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaling</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">Sig</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scaling</span>

        <span class="k">if</span> <span class="n">ispin</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">nspin</span><span class="p">:</span>
            <span class="n">ispin</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Warning: Non-spinpolarized electrode calculation used for both spin up and down&quot;</span><span class="p">)</span>

        <span class="n">NA1</span><span class="p">,</span> <span class="n">NA2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NA1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NA2</span>
        <span class="n">nuo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">nuo</span>

        <span class="c1"># First make it easy</span>
        <span class="c1"># If NA1*NA2 == 1 then no repetition is needed</span>
        <span class="k">if</span> <span class="n">NA1</span> <span class="o">*</span> <span class="n">NA2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">SGF</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getg0</span><span class="p">(</span><span class="n">eeshifted</span><span class="o">+</span><span class="mi">1j</span><span class="o">*</span><span class="n">etaLead</span><span class="p">,</span> <span class="n">qp</span><span class="p">,</span>
                             <span class="n">left</span><span class="o">=</span><span class="n">left</span><span class="p">,</span> <span class="n">ispin</span><span class="o">=</span><span class="n">ispin</span><span class="p">,</span> <span class="n">UseF90</span><span class="o">=</span><span class="n">UseF90helpers</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Bulk</span><span class="p">:</span>
                <span class="c1"># We only need to calculate this quantity</span>
                <span class="c1"># if not bulk</span>
                <span class="n">ESH</span> <span class="o">=</span> <span class="n">eeshifted</span><span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">ispin</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

        <span class="k">elif</span> <span class="n">SIO</span><span class="o">.</span><span class="n">F90imported</span> <span class="ow">and</span> <span class="n">UseF90helpers</span><span class="p">:</span>

            <span class="n">g0</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nuo</span><span class="p">,</span> <span class="n">nuo</span><span class="p">,</span> <span class="n">NA1</span><span class="o">*</span><span class="n">NA2</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">complex</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
            <span class="n">mESH</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nuo</span><span class="p">,</span> <span class="n">nuo</span><span class="p">,</span> <span class="n">NA1</span><span class="o">*</span><span class="n">NA2</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">complex</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>

            <span class="n">iq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">ik2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NA2</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ik1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NA1</span><span class="p">):</span>
                    <span class="n">iq</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">kpoint</span> <span class="o">=</span> <span class="n">qp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># Checked against 1x1 and 3x3 electrode calculation</span>
                    <span class="n">kpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">kpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="nb">float</span><span class="p">(</span><span class="n">ik1</span><span class="p">))</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">NA1</span><span class="p">)</span>
                    <span class="n">kpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">kpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="nb">float</span><span class="p">(</span><span class="n">ik2</span><span class="p">))</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">NA2</span><span class="p">)</span>
                    <span class="c1"># Surface GF with possible extra imaginary part (etaLead):</span>
                    <span class="n">g0</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">iq</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getg0</span><span class="p">(</span><span class="n">eeshifted</span><span class="o">+</span><span class="mi">1j</span><span class="o">*</span><span class="n">etaLead</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="n">left</span><span class="p">,</span> <span class="n">ispin</span><span class="o">=</span><span class="n">ispin</span><span class="p">,</span> <span class="n">UseF90</span><span class="o">=</span><span class="n">UseF90helpers</span><span class="p">)</span>
                    <span class="n">mESH</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">iq</span><span class="p">]</span> <span class="o">=</span> <span class="n">eeshifted</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">ispin</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

            <span class="n">ESH</span><span class="p">,</span> <span class="n">SGF</span> <span class="o">=</span> <span class="n">SIO</span><span class="o">.</span><span class="n">F90</span><span class="o">.</span><span class="n">expansion_se</span><span class="p">(</span><span class="n">no_u</span><span class="o">=</span><span class="n">nuo</span><span class="p">,</span> <span class="n">no_s</span><span class="o">=</span><span class="n">nuo</span><span class="o">*</span><span class="n">NA1</span><span class="o">*</span><span class="n">NA2</span><span class="p">,</span> <span class="n">na1</span><span class="o">=</span><span class="n">NA1</span><span class="p">,</span> <span class="n">na2</span><span class="o">=</span><span class="n">NA2</span><span class="p">,</span> <span class="n">kpt</span><span class="o">=</span><span class="n">qp</span><span class="p">,</span>
                                            <span class="n">na_u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">nua</span><span class="p">,</span> <span class="n">lasto</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">lasto</span><span class="p">,</span> <span class="n">esh</span><span class="o">=</span><span class="n">mESH</span><span class="p">,</span> <span class="n">g0</span><span class="o">=</span><span class="n">g0</span><span class="p">)</span>
            <span class="c1"># Clean up before calculating the self-energy</span>
            <span class="k">del</span> <span class="n">g0</span><span class="p">,</span> <span class="n">mESH</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># Make list for the loop containing</span>
            <span class="c1">#       [iatom,i1,i2,SGFstart,SGFend,g0start,g0end]</span>
            <span class="c1"># where iatom is the atom number in g0 corresponding to g0start and g0end orbital</span>
            <span class="c1"># i1 and i2 posision in the repeated lattice which together with iatom gives SGFstart/end</span>
            <span class="n">nua</span><span class="p">,</span> <span class="n">lasto</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">nua</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">lasto</span>
            <span class="n">SGFstart</span><span class="p">,</span> <span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ia</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nua</span><span class="p">):</span>         <span class="c1"># Atoms in electrode</span>
                <span class="n">g0start</span><span class="p">,</span> <span class="n">g0end</span> <span class="o">=</span> <span class="n">lasto</span><span class="p">[</span><span class="n">ia</span><span class="p">],</span> <span class="n">lasto</span><span class="p">[</span><span class="n">ia</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
                <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NA2</span><span class="p">):</span>     <span class="c1"># Repetition NA2</span>
                    <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NA1</span><span class="p">):</span> <span class="c1"># Repetition NA1</span>
                        <span class="n">SGFend</span> <span class="o">=</span> <span class="n">SGFstart</span><span class="o">+</span><span class="p">(</span><span class="n">g0end</span><span class="o">-</span><span class="n">g0start</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="c1"># add the number of orbitals in atom ia</span>
                        <span class="n">loop</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ia</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">SGFstart</span><span class="p">,</span> <span class="n">SGFend</span><span class="p">,</span> <span class="n">g0start</span><span class="p">,</span> <span class="n">g0end</span><span class="p">])</span>
                        <span class="n">SGFstart</span> <span class="o">=</span> <span class="n">SGFend</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">SGFstart</span> <span class="o">!=</span> <span class="n">NA1</span><span class="o">*</span><span class="n">NA2</span><span class="o">*</span><span class="n">nuo</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error: Check of orbitals in making Sigma not correct&quot;</span><span class="p">)</span>
            <span class="c1"># Complete the full Gs with atoms copied out NA1*NA2</span>
            <span class="c1"># To obtain Sigma we also need H expanded, i.e.,</span>
            <span class="c1"># Gs = (E S - H - Sig)^-1 -&gt; Sig = E S - H-SGF^-1</span>
            <span class="c1"># ESmH = E S - H</span>
            <span class="n">SGF</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">NA1</span><span class="o">*</span><span class="n">NA2</span><span class="o">*</span><span class="n">nuo</span><span class="p">,</span> <span class="n">NA1</span><span class="o">*</span><span class="n">NA2</span><span class="o">*</span><span class="n">nuo</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
            <span class="n">ESH</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">NA1</span><span class="o">*</span><span class="n">NA2</span><span class="o">*</span><span class="n">nuo</span><span class="p">,</span> <span class="n">NA1</span><span class="o">*</span><span class="n">NA2</span><span class="o">*</span><span class="n">nuo</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span> <span class="c1"># Temporary E S00 - H00</span>
            <span class="k">for</span> <span class="n">ik2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NA2</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ik1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NA1</span><span class="p">):</span>
                    <span class="n">kpoint</span> <span class="o">=</span> <span class="n">qp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># Checked against 1x1 and 3x3 electrode calculation</span>
                    <span class="n">kpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">kpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">NA1</span>
                    <span class="n">kpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">kpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">NA2</span>
                    <span class="n">kpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ik1</span><span class="o">*</span><span class="mf">1.0</span><span class="o">/</span><span class="n">NA1</span>
                    <span class="n">kpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ik2</span><span class="o">*</span><span class="mf">1.0</span><span class="o">/</span><span class="n">NA2</span>
                    <span class="c1"># Surface GF with possible extra imaginary part (etaLead):</span>
                    <span class="n">g0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getg0</span><span class="p">(</span><span class="n">eeshifted</span><span class="o">+</span><span class="mi">1j</span><span class="o">*</span><span class="n">etaLead</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="n">left</span><span class="p">,</span> <span class="n">ispin</span><span class="o">=</span><span class="n">ispin</span><span class="p">,</span> <span class="n">UseF90</span><span class="o">=</span><span class="n">UseF90helpers</span><span class="p">)</span>

                    <span class="n">matESmH</span> <span class="o">=</span> <span class="n">eeshifted</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">ispin</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                    <span class="k">for</span> <span class="n">ia</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">iSGFs</span><span class="p">,</span> <span class="n">iSGFe</span><span class="p">,</span> <span class="n">ig0s</span><span class="p">,</span> <span class="n">ig0e</span> <span class="ow">in</span> <span class="n">loop</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">ja</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">,</span> <span class="n">jSGFs</span><span class="p">,</span> <span class="n">jSGFe</span><span class="p">,</span> <span class="n">jg0s</span><span class="p">,</span> <span class="n">jg0e</span> <span class="ow">in</span> <span class="n">loop</span><span class="p">:</span>
                            <span class="c1"># Same convention as for H_ij above: exp(2 pi i k * (jatom-iatom))</span>
                            <span class="c1"># The phases etc have been checked by comparing the self-energy from</span>
                            <span class="c1"># 1x1 and 3x3 electrode calculations</span>
                            <span class="n">phase</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">NA1</span><span class="o">*</span><span class="n">NA2</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0j</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">((</span><span class="n">j1</span><span class="o">-</span><span class="n">i1</span><span class="p">)</span><span class="o">*</span><span class="n">kpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">j2</span><span class="o">-</span><span class="n">i2</span><span class="p">)</span><span class="o">*</span><span class="n">kpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                            <span class="n">ESH</span><span class="p">[</span><span class="n">iSGFs</span><span class="p">:</span><span class="n">iSGFe</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">jSGFs</span><span class="p">:</span><span class="n">jSGFe</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">phase</span><span class="o">*</span><span class="n">matESmH</span><span class="p">[</span><span class="n">ig0s</span><span class="p">:</span><span class="n">ig0e</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">jg0s</span><span class="p">:</span><span class="n">jg0e</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">SGF</span><span class="p">[</span><span class="n">iSGFs</span><span class="p">:</span><span class="n">iSGFe</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">jSGFs</span><span class="p">:</span><span class="n">jSGFe</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">phase</span><span class="o">*</span><span class="n">g0</span><span class="p">[</span><span class="n">ig0s</span><span class="p">:</span><span class="n">ig0e</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">jg0s</span><span class="p">:</span><span class="n">jg0e</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Calculate self-energy or inverse of SGF for Bulk: SGF^-1 = E S - H - Sig</span>
        <span class="k">if</span> <span class="n">Bulk</span><span class="p">:</span>
            <span class="n">Sig</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">SGF</span><span class="p">)</span> <span class="c1"># SGF^1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Sig</span> <span class="o">=</span> <span class="n">ESH</span> <span class="o">-</span> <span class="n">LA</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">SGF</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">useSigNCfiles</span><span class="p">:</span>
            <span class="n">SavedSig</span><span class="o">.</span><span class="n">addSig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">,</span> <span class="n">eeshifted</span><span class="p">,</span> <span class="n">qp</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">ispin</span><span class="p">,</span> <span class="n">etaLead</span><span class="p">,</span> <span class="n">Sig</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaling</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;NEGF.getSig: Scaling self-energy with a factor&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaling</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Sig</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scaling</span></div>

<div class="viewcode-block" id="ElectrodeSelfEnergy.getg0"><a class="viewcode-back" href="../../api-gen/Inelastica.NEGF.html#Inelastica.NEGF.ElectrodeSelfEnergy.getg0">[docs]</a>    <span class="k">def</span> <span class="nf">getg0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ee</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">ispin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">UseF90</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="c1"># Calculate surface Green&#39;s function for small electrode calculation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupHS</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span>
        <span class="c1">#print &quot;NEGF.getg0: Constructing surface GF at (ReE,ImE) = (%.6e,%6e)&quot;%(ee.real,ee.imag)</span>

        <span class="k">if</span> <span class="n">F90_lapack_imp</span> <span class="ow">and</span> <span class="n">UseF90</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">F90calcg0</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="n">left</span><span class="p">,</span> <span class="n">ispin</span><span class="o">=</span><span class="n">ispin</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcg0_old</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="n">left</span><span class="p">,</span> <span class="n">ispin</span><span class="o">=</span><span class="n">ispin</span><span class="p">)</span></div>
        <span class="c1">#Potentially faster method but seems to have numerical instability</span>
        <span class="c1">#if hasSciPy and :</span>
        <span class="c1">#    return self.calcg0(ee,left=left,ispin=ispin)</span>
        <span class="c1">#else:</span>
        <span class="c1">#    return self.calcg0_old(ee,left=left,ispin=ispin)</span>

<div class="viewcode-block" id="ElectrodeSelfEnergy.calcg0"><a class="viewcode-back" href="../../api-gen/Inelastica.NEGF.html#Inelastica.NEGF.ElectrodeSelfEnergy.calcg0">[docs]</a>    <span class="k">def</span> <span class="nf">calcg0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ee</span><span class="p">,</span> <span class="n">ispin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="c1"># Calculate surface Green&#39;s function</span>
        <span class="c1"># Euro Phys J B 62, 381 (2008)</span>
        <span class="c1"># Inverse of : NOTE, setup for &quot;right&quot; lead.</span>
        <span class="c1"># e-h00 -h01  ...</span>
        <span class="c1"># -h10  e-h00 ...</span>
        <span class="n">h00</span><span class="p">,</span> <span class="n">s00</span><span class="p">,</span> <span class="n">h01</span><span class="p">,</span> <span class="n">s01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">ispin</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H01</span><span class="p">[</span><span class="n">ispin</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">S01</span>
        <span class="n">NN</span><span class="p">,</span> <span class="n">ee</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">h00</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">ee</span><span class="p">)</span><span class="o">+</span><span class="n">N</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">N</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">ee</span><span class="p">),</span> <span class="mf">1e-8</span><span class="p">])</span><span class="o">*</span><span class="mf">1.0j</span>
        <span class="k">if</span> <span class="n">left</span><span class="p">:</span>
            <span class="n">h01</span><span class="p">,</span> <span class="n">s01</span> <span class="o">=</span> <span class="n">MM</span><span class="o">.</span><span class="n">dagger</span><span class="p">(</span><span class="n">h01</span><span class="p">),</span> <span class="n">MM</span><span class="o">.</span><span class="n">dagger</span><span class="p">(</span><span class="n">s01</span><span class="p">)</span>

        <span class="c1"># Solve generalized eigen-problem</span>
        <span class="c1"># ( e I - h00 , -I) (eps)          (h01 , 0) (eps)</span>
        <span class="c1"># ( h10       ,  0) (xi ) = lambda (0   , I) (xi )</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">NN</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">NN</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">complex</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">NN</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">NN</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
        <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">NN</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">NN</span><span class="p">]</span> <span class="o">=</span> <span class="n">ee</span><span class="o">*</span><span class="n">s00</span><span class="o">-</span><span class="n">h00</span>
        <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">NN</span><span class="p">,</span> <span class="n">NN</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">NN</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">N</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">NN</span><span class="p">)</span>
        <span class="n">a</span><span class="p">[</span><span class="n">NN</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">NN</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">NN</span><span class="p">]</span> <span class="o">=</span> <span class="n">MM</span><span class="o">.</span><span class="n">dagger</span><span class="p">(</span><span class="n">h01</span><span class="p">)</span><span class="o">-</span><span class="n">ee</span><span class="o">*</span><span class="n">MM</span><span class="o">.</span><span class="n">dagger</span><span class="p">(</span><span class="n">s01</span><span class="p">)</span>
        <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">NN</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">NN</span><span class="p">]</span> <span class="o">=</span> <span class="n">h01</span><span class="o">-</span><span class="n">ee</span><span class="o">*</span><span class="n">s01</span>
        <span class="n">b</span><span class="p">[</span><span class="n">NN</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">NN</span><span class="p">,</span> <span class="n">NN</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">NN</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">NN</span><span class="p">)</span>
        <span class="n">ev</span><span class="p">,</span> <span class="n">evec</span> <span class="o">=</span> <span class="n">SLA</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

        <span class="c1"># Select lambda &lt;0 and the eps part of the evec</span>
        <span class="n">ipiv</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ev</span><span class="p">,</span> <span class="n">evec</span> <span class="o">=</span> <span class="n">ev</span><span class="p">[</span><span class="n">ipiv</span><span class="p">],</span> <span class="n">N</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">evec</span><span class="p">[:</span><span class="n">NN</span><span class="p">,</span> <span class="n">ipiv</span><span class="p">])</span>
        <span class="c1"># Normalize evec</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">evec</span><span class="p">,</span> <span class="n">MM</span><span class="o">.</span><span class="n">dagger</span><span class="p">(</span><span class="n">evec</span><span class="p">))))</span>
        <span class="n">evec</span> <span class="o">=</span> <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">norm</span><span class="p">),</span> <span class="n">evec</span><span class="p">)</span>

        <span class="c1"># E^+ Lambda_+ (E^+)^-1 ---&gt;&gt;&gt; g00</span>
        <span class="n">EP</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">evec</span><span class="p">)</span>
        <span class="n">FP</span> <span class="o">=</span> <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">EP</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">ev</span><span class="p">),</span> <span class="n">LA</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">MM</span><span class="o">.</span><span class="n">dagger</span><span class="p">(</span><span class="n">EP</span><span class="p">),</span> <span class="n">EP</span><span class="p">)),</span> <span class="n">MM</span><span class="o">.</span><span class="n">dagger</span><span class="p">(</span><span class="n">EP</span><span class="p">))</span>
        <span class="n">g00</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">ee</span><span class="o">*</span><span class="n">s00</span><span class="o">-</span><span class="n">h00</span><span class="o">-</span><span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">h01</span><span class="o">-</span><span class="n">ee</span><span class="o">*</span><span class="n">s01</span><span class="p">,</span> <span class="n">FP</span><span class="p">))</span>

        <span class="c1"># Check!</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">g00</span><span class="o">-</span><span class="n">LA</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">ee</span><span class="o">*</span><span class="n">s00</span><span class="o">-</span><span class="n">h00</span><span class="o">-</span>\
                                     <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">h01</span><span class="o">-</span><span class="n">ee</span><span class="o">*</span><span class="n">s01</span><span class="p">,</span> <span class="n">g00</span><span class="p">,</span> <span class="n">MM</span><span class="o">.</span><span class="n">dagger</span><span class="p">(</span><span class="n">h01</span><span class="p">)</span><span class="o">-</span><span class="n">ee</span><span class="o">*</span><span class="n">MM</span><span class="o">.</span><span class="n">dagger</span><span class="p">(</span><span class="n">s01</span><span class="p">)))))</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">&gt;</span> <span class="mf">1.0e-8</span> <span class="ow">and</span> <span class="n">left</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;WARNING: Lopez-scheme not-so-well converged for LEFT electrode at E = </span><span class="si">%.4f</span><span class="s2"> eV:&quot;</span><span class="o">%</span><span class="n">ee</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">&gt;</span> <span class="mf">1.0e-8</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">left</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;WARNING: Lopez-scheme not-so-well converged for RIGHT electrode at E = </span><span class="si">%.4f</span><span class="s2"> eV:&quot;</span><span class="o">%</span><span class="n">ee</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">g00</span></div>

<div class="viewcode-block" id="ElectrodeSelfEnergy.F90calcg0"><a class="viewcode-back" href="../../api-gen/Inelastica.NEGF.html#Inelastica.NEGF.ElectrodeSelfEnergy.F90calcg0">[docs]</a>    <span class="k">def</span> <span class="nf">F90calcg0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ee</span><span class="p">,</span> <span class="n">ispin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call the fortran equivalent routine of the Lopez-Sancho algorithm also</span>
<span class="sd">        utilised in tbtrans.</span>
<span class="sd">        Coded by Nick Papior Andersen</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">no</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">ispin</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
        <span class="n">oHs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">oSs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">shape</span>
        <span class="c1"># due to an implementation not fully complete we need to transfer the shapes (luckily</span>
        <span class="c1"># the shape is just an internal parameter, and any data transfer is not needed...)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">size</span><span class="p">,)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H01</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S01</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">F90</span><span class="o">.</span><span class="n">surfacegreen</span><span class="p">(</span><span class="n">no</span><span class="o">=</span><span class="n">no</span><span class="p">,</span> <span class="n">ze</span><span class="o">=</span><span class="n">ee</span><span class="p">,</span> <span class="n">h00</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">ispin</span><span class="p">],</span> <span class="n">s00</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span>
                               <span class="n">h01</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">H01</span><span class="p">[</span><span class="n">ispin</span><span class="p">],</span> <span class="n">s01</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">S01</span><span class="p">,</span>
                               <span class="n">accur</span><span class="o">=</span><span class="mf">1.e-15</span><span class="p">,</span> <span class="n">is_left</span><span class="o">=</span><span class="n">left</span><span class="p">)</span>
        <span class="n">tmp</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">no</span><span class="p">,</span> <span class="n">no</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">requirements</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">oHs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">oSs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H01</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">oHs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S01</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">oSs</span>
        <span class="k">return</span> <span class="n">tmp</span></div>

<div class="viewcode-block" id="ElectrodeSelfEnergy.calcg0_old"><a class="viewcode-back" href="../../api-gen/Inelastica.NEGF.html#Inelastica.NEGF.ElectrodeSelfEnergy.calcg0_old">[docs]</a>    <span class="k">def</span> <span class="nf">calcg0_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ee</span><span class="p">,</span> <span class="n">ispin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Only used if SciPy is not installed!</span>
<span class="sd">        For the left surface Green&#39;s function  (1 is surface layer, 0 is all the other atoms):</span>
<span class="sd">        (E S00-H00  E S01-H01)   (g00 g01)    ( I 0 )</span>
<span class="sd">        (E S10-H10  E S11-H11) * (g01 g11)  = ( 0 I ) -&gt;</span>
<span class="sd">        call E S - H for t ...</span>

<span class="sd">        t00 g01 + t01 g11 = 0  -&gt; g01 = - t00^-1 t01 g11</span>
<span class="sd">        t10 g01 + t11 g11 = I -&gt; - t10 t00^-1 t01 g11 + t11 g11 = I -&gt;</span>

<span class="sd">        And we get the surface Green&#39;s function:</span>

<span class="sd">        g11 = (t11 - t10 t00^-1 t01)^-1 with the right size of unitcell t00^-1 = g11!</span>
<span class="sd">        g11 = (E S11 - H11 - (E S10 - H10) g11 (E S01 - H01))^-1</span>

<span class="sd">        In the calculations H01^+ and S01^+ are used instead of S10 and H10.</span>
<span class="sd">        (For complex energies (E S01 -H01)^+ is not (E S10 -H10) because the conjugate of the energy!!!!)</span>

<span class="sd">        For the right surface greens function same but different order on the MM.daggers!</span>
<span class="sd">        i.e., (E S - H - (E S01 - H01) gs (E S01^+ -H01^+)</span>

<span class="sd">        Algorith: Lopez Sancho*2 J Phys F:Met Phys 15 (1985) 851</span>

<span class="sd">        I&#39;m still very suspicios of this algorithm ... but it works and is really quick!</span>
<span class="sd">        The convergence is always checked against gs (E S - H - (E S01^+ - H01^+) gs (E S01 -H01) ) = I!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">H</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">H01</span><span class="p">,</span> <span class="n">S01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">ispin</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H01</span><span class="p">[</span><span class="n">ispin</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">S01</span>

        <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span> <span class="o">=</span> <span class="n">MM</span><span class="o">.</span><span class="n">dagger</span><span class="p">(</span><span class="n">H01</span><span class="p">)</span><span class="o">-</span><span class="n">ee</span><span class="o">*</span><span class="n">MM</span><span class="o">.</span><span class="n">dagger</span><span class="p">(</span><span class="n">S01</span><span class="p">),</span> <span class="n">H01</span><span class="o">-</span><span class="n">ee</span><span class="o">*</span><span class="n">S01</span>
        <span class="n">eps</span><span class="p">,</span> <span class="n">epss</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">H</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">converged</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">iteration</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">converged</span><span class="p">:</span>
            <span class="n">iteration</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">oldeps</span><span class="p">,</span> <span class="n">oldepss</span> <span class="o">=</span> <span class="n">eps</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">epss</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">oldalpha</span><span class="p">,</span> <span class="n">oldbeta</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">beta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">tmpa</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">ee</span><span class="o">*</span><span class="n">S</span> <span class="o">-</span> <span class="n">oldeps</span><span class="p">,</span> <span class="n">oldalpha</span><span class="p">)</span>
            <span class="n">tmpb</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">ee</span><span class="o">*</span><span class="n">S</span> <span class="o">-</span> <span class="n">oldeps</span><span class="p">,</span> <span class="n">oldbeta</span><span class="p">)</span>
            <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span> <span class="o">=</span> <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">oldalpha</span><span class="p">,</span> <span class="n">tmpa</span><span class="p">),</span> <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">oldbeta</span><span class="p">,</span> <span class="n">tmpb</span><span class="p">)</span>
            <span class="n">eps</span> <span class="o">=</span> <span class="n">oldeps</span> <span class="o">+</span> <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">oldalpha</span><span class="p">,</span> <span class="n">tmpb</span><span class="p">)</span><span class="o">+</span><span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">oldbeta</span><span class="p">,</span> <span class="n">tmpa</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">left</span><span class="p">:</span>
                <span class="n">epss</span> <span class="o">=</span> <span class="n">oldepss</span> <span class="o">+</span> <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">oldalpha</span><span class="p">,</span> <span class="n">tmpb</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">epss</span> <span class="o">=</span> <span class="n">oldepss</span> <span class="o">+</span> <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">oldbeta</span><span class="p">,</span> <span class="n">tmpa</span><span class="p">)</span>
            <span class="n">LopezConvTest</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">beta</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">LopezConvTest</span> <span class="o">&lt;</span> <span class="mf">1.0e-40</span><span class="p">:</span>
                <span class="n">gs</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">ee</span><span class="o">*</span><span class="n">S</span><span class="o">-</span><span class="n">epss</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">left</span><span class="p">:</span>
                    <span class="n">test</span> <span class="o">=</span> <span class="n">ee</span><span class="o">*</span><span class="n">S</span><span class="o">-</span><span class="n">H</span><span class="o">-</span><span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">ee</span><span class="o">*</span><span class="n">MM</span><span class="o">.</span><span class="n">dagger</span><span class="p">(</span><span class="n">S01</span><span class="p">)</span><span class="o">-</span><span class="n">MM</span><span class="o">.</span><span class="n">dagger</span><span class="p">(</span><span class="n">H01</span><span class="p">),</span> <span class="n">gs</span><span class="p">,</span> <span class="n">ee</span><span class="o">*</span><span class="n">S01</span><span class="o">-</span><span class="n">H01</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">test</span> <span class="o">=</span> <span class="n">ee</span><span class="o">*</span><span class="n">S</span><span class="o">-</span><span class="n">H</span><span class="o">-</span><span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">ee</span><span class="o">*</span><span class="n">S01</span><span class="o">-</span><span class="n">H01</span><span class="p">,</span> <span class="n">gs</span><span class="p">,</span> <span class="n">ee</span><span class="o">*</span><span class="n">MM</span><span class="o">.</span><span class="n">dagger</span><span class="p">(</span><span class="n">S01</span><span class="p">)</span><span class="o">-</span><span class="n">MM</span><span class="o">.</span><span class="n">dagger</span><span class="p">(</span><span class="n">H01</span><span class="p">))</span>
                <span class="n">myConvTest</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">gs</span><span class="p">)</span><span class="o">-</span><span class="n">N</span><span class="o">.</span><span class="n">identity</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">nuo</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">complex</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">myConvTest</span> <span class="o">&lt;</span> <span class="n">VC</span><span class="o">.</span><span class="n">GetCheck</span><span class="p">(</span><span class="s2">&quot;Lopez-Sancho&quot;</span><span class="p">):</span>
                    <span class="n">converged</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">if</span> <span class="n">myConvTest</span> <span class="o">&gt;</span> <span class="n">VC</span><span class="o">.</span><span class="n">GetCheck</span><span class="p">(</span><span class="s2">&quot;Lopez-Sancho-warning&quot;</span><span class="p">):</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="s2">&quot;RIGHT&quot;</span>
                        <span class="k">if</span> <span class="n">left</span><span class="p">:</span> <span class="n">v</span> <span class="o">=</span> <span class="s2">&quot;LEFT&quot;</span>
                        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;WARNING: Lopez-scheme not-so-well converged for &quot;</span><span class="o">+</span><span class="n">v</span><span class="o">+</span><span class="s2">&quot; electrode at E = </span><span class="si">%.4f</span><span class="s2"> eV:&quot;</span><span class="o">%</span><span class="n">ee</span><span class="p">,</span> <span class="n">myConvTest</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">VC</span><span class="o">.</span><span class="n">Check</span><span class="p">(</span><span class="s2">&quot;Lopez-Sancho&quot;</span><span class="p">,</span> <span class="n">myConvTest</span><span class="p">,</span>
                             <span class="s2">&quot;Error: gs iteration {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iteration</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">gs</span></div>

<div class="viewcode-block" id="ElectrodeSelfEnergy.setupHS"><a class="viewcode-back" href="../../api-gen/Inelastica.NEGF.html#Inelastica.NEGF.ElectrodeSelfEnergy.setupHS">[docs]</a>    <span class="k">def</span> <span class="nf">setupHS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setup H, S, H01 and S01 where H01 has large elements in the lower left corner, i.e., H01 = Hi,i+1</span>
<span class="sd">        (... 0     H01^+ H     H01   0      ...  )</span>
<span class="sd">        (... 0     0     H01^+ H     H01    0      ...  )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Save time by not repeating too often</span>
        <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">kpoint</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoint</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">1e-10</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kpoint</span> <span class="o">=</span> <span class="n">kpoint</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># Do the trick:</span>
            <span class="c1"># H(k=0)+H(kz=0.5) = H + H01 + H10 + H - H01 - H10 = 2 H</span>
            <span class="n">kp</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>

            <span class="n">kp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">kpoint</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">setkpoint</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">tmpH</span><span class="p">,</span> <span class="n">tmpS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="n">kp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">semiinf</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">setkpoint</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">tmpH</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">H</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">tmpS</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">S</span><span class="p">)</span>

            <span class="c1"># Additional trick:</span>
            <span class="c1"># 1: -i*(H(kz=0.25)-H) = -i*(H + i*H01 - i*H10-H) = H01-H10</span>
            <span class="c1"># 2: H(kz=0)-H  = H + H01 + H10 - H =  H01+H10</span>
            <span class="c1"># -&gt; H10 = (-i*(H(kz=0.25)-H) + H(kz=0)-H)/2</span>
            <span class="n">kp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">semiinf</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.25</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">setkpoint</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">H01</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">1j</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">H</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">)</span> <span class="o">+</span> <span class="n">tmpH</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">S01</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">1j</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">S</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">)</span> <span class="o">+</span> <span class="n">tmpS</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">resetkpoint</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">tmpH</span><span class="p">,</span> <span class="n">tmpS</span></div></div>

<span class="c1">#############################################################################</span>


<div class="viewcode-block" id="GF"><a class="viewcode-back" href="../../api-gen/Inelastica.NEGF.html#Inelastica.NEGF.GF">[docs]</a><span class="k">class</span> <span class="nc">GF</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">TSHSfile</span><span class="p">,</span> <span class="n">elecL</span><span class="p">,</span> <span class="n">elecR</span><span class="p">,</span> <span class="n">Bulk</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">DeviceAtoms</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">BufferAtoms</span><span class="o">=</span><span class="n">N</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,))):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate Green&#39;s functions etc for TSHSfile connected to left/right</span>
<span class="sd">        electrode (class ElectrodeSelfEnergy).</span>
<span class="sd">        To speed up calculations folding to smaller device region suggested</span>
<span class="sd">        For spin-polarized calcGF has to be called for each ispin</span>
<span class="sd">        Variables:</span>
<span class="sd">        Gr     : Retarded Green&#39;s function, folded</span>
<span class="sd">        H,S    : Hamiltonian, overlap, folded</span>
<span class="sd">        H0,S0  : Hamiltonian, overlap, not folded</span>
<span class="sd">        nuo    : Size of Gr</span>
<span class="sd">        SigL, SigR, GamL, GamR : Self energy, Gamma NOTE, not same size as Gr!</span>
<span class="sd">        nuoL, nuoR : Size of Sig, Gam</span>
<span class="sd">        nuo0, nuoL0, nuoR0 : Non-folded sizes</span>
<span class="sd">        FoldedL, FoldedR : True/False</span>
<span class="sd">        DeviceAtoms : start/end Siesta numbering of atoms included in device</span>
<span class="sd">        DeviceOrbs : Start/end of orbitals. Siesta ordering.</span>
<span class="sd">        BufferAtoms: A list of buffer atoms</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elecL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elecR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bulk</span> <span class="o">=</span> <span class="n">elecL</span><span class="p">,</span> <span class="n">elecR</span><span class="p">,</span> <span class="n">Bulk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HS</span> <span class="o">=</span> <span class="n">SIO</span><span class="o">.</span><span class="n">HS</span><span class="p">(</span><span class="n">TSHSfile</span><span class="p">,</span> <span class="n">BufferAtoms</span><span class="o">=</span><span class="n">BufferAtoms</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;GF: UseBulk=&#39;</span><span class="p">,</span> <span class="n">Bulk</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DeviceAtoms</span> <span class="o">=</span> <span class="n">DeviceAtoms</span>
        <span class="k">if</span> <span class="n">DeviceAtoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">DeviceAtoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FoldedL</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FoldedL</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">DeviceAtoms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">DeviceAtoms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">nua</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">DeviceAtoms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">nua</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FoldedR</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FoldedR</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DeviceOrbs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">lasto</span><span class="p">[</span><span class="n">DeviceAtoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">lasto</span><span class="p">[</span><span class="n">DeviceAtoms</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nuo0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuoL0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuoR0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">nuo</span><span class="p">,</span> <span class="n">elecL</span><span class="o">.</span><span class="n">NA1</span><span class="o">*</span><span class="n">elecL</span><span class="o">.</span><span class="n">NA2</span><span class="o">*</span><span class="n">elecL</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">nuo</span><span class="p">,</span> <span class="n">elecR</span><span class="o">.</span><span class="n">NA1</span><span class="o">*</span><span class="n">elecR</span><span class="o">.</span><span class="n">NA2</span><span class="o">*</span><span class="n">elecR</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">nuo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nuo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DeviceOrbs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">DeviceOrbs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nuoL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuoR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuoL0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuoR0</span> <span class="c1"># Not folded, for folded case changed below</span>

        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;GF:&quot;</span><span class="p">,</span> <span class="n">TSHSfile</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Device atoms </span><span class="si">%i</span><span class="s2">-</span><span class="si">%i</span><span class="s2">, orbitals </span><span class="si">%i</span><span class="s2">-</span><span class="si">%i</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DeviceAtoms</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">DeviceOrbs</span><span class="p">)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">FoldedL</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Suggest left folding to atom : &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elecL</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">nua</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">elecL</span><span class="o">.</span><span class="n">NA1</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">elecL</span><span class="o">.</span><span class="n">NA2</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">FoldedR</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Suggest right folding to atom : &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">nua</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">elecR</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">nua</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">elecR</span><span class="o">.</span><span class="n">NA1</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">elecR</span><span class="o">.</span><span class="n">NA2</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">FoldedL</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">FoldedR</span><span class="p">:</span>
            <span class="c1"># Check that device region is large enough!</span>
            <span class="n">kpoint</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,),</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setkpoint</span><span class="p">(</span><span class="n">kpoint</span><span class="p">,</span> <span class="n">ispin</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># At least for one spin</span>

            <span class="n">devSt</span><span class="p">,</span> <span class="n">devEnd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DeviceOrbs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">DeviceOrbs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">VC</span><span class="o">.</span><span class="n">Check</span><span class="p">(</span><span class="s2">&quot;Device-Elec-overlap&quot;</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S0</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">devSt</span><span class="p">,</span> <span class="n">devEnd</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nuo0</span><span class="p">]),</span>
                     <span class="s2">&quot;Too much overlap directly from left-top right&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;Make device region larger&quot;</span><span class="p">)</span>
            <span class="n">VC</span><span class="o">.</span><span class="n">Check</span><span class="p">(</span><span class="s2">&quot;Device-Elec-overlap&quot;</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H0</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">devSt</span><span class="p">,</span> <span class="n">devEnd</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nuo0</span><span class="p">]),</span>
                     <span class="s2">&quot;Too large Hamiltonian directly from left-top right.&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;Make device region larger&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">FoldedL</span><span class="p">:</span>
            <span class="c1"># Find orbitals in device region coupling to left and right.</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S0</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">devSt</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">devEnd</span><span class="p">])</span>
            <span class="n">coupling</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="n">devEnd</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">while</span> <span class="n">coupling</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">:</span> <span class="n">ii</span> <span class="o">=</span> <span class="n">ii</span><span class="o">-</span><span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">devEndL</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuoL0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nuoL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">devEndL</span><span class="o">-</span><span class="n">devSt</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Left self energy on orbitals </span><span class="si">%i</span><span class="s2">-</span><span class="si">%i</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">devSt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">devEndL</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">FoldedR</span><span class="p">:</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S0</span><span class="p">[</span><span class="n">devEnd</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nuo0</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nuo0</span><span class="p">])</span>
            <span class="n">coupling</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="n">devSt</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">while</span> <span class="n">coupling</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">:</span> <span class="n">ii</span> <span class="o">=</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">devStR</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuo0</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">nuoR0</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nuoR</span> <span class="o">=</span> <span class="n">devEnd</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">devStR</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Right self energy on orbitals </span><span class="si">%i</span><span class="s2">-</span><span class="si">%i</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">devStR</span><span class="p">,</span> <span class="n">devEnd</span><span class="p">))</span>
        <span class="c1"># Quantities expressed in nonorthogonal basis:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OrthogonalDeviceRegion</span> <span class="o">=</span> <span class="bp">False</span>

<div class="viewcode-block" id="GF.calcSigLR"><a class="viewcode-back" href="../../api-gen/Inelastica.NEGF.html#Inelastica.NEGF.GF.calcSigLR">[docs]</a>    <span class="k">def</span> <span class="nf">calcSigLR</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ee</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">ispin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">etaLead</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">useSigNCfiles</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">SpectralCutoff</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate (folded) self-energy at energy ee and 2d k-point</span>
<span class="sd">        Uses SpectralMatrix format for the spectralfunction matrices, see Inelastica.math, if cutoff&gt;0.0</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">nuoL</span><span class="p">,</span> <span class="n">nuoR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuoL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuoR</span>
        <span class="n">nuo0</span><span class="p">,</span> <span class="n">nuoL0</span><span class="p">,</span> <span class="n">nuoR0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuo0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuoL0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuoR0</span>
        <span class="n">FoldedL</span><span class="p">,</span> <span class="n">FoldedR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FoldedL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FoldedR</span>
        <span class="n">devSt</span><span class="p">,</span> <span class="n">devEnd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DeviceOrbs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">DeviceOrbs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># Calculate Sigma without folding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setkpoint</span><span class="p">(</span><span class="n">kpoint</span><span class="p">,</span> <span class="n">ispin</span><span class="p">)</span>
        <span class="n">SigL0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elecL</span><span class="o">.</span><span class="n">getSig</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">Bulk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Bulk</span><span class="p">,</span> <span class="n">ispin</span><span class="o">=</span><span class="n">ispin</span><span class="p">,</span> <span class="n">etaLead</span><span class="o">=</span><span class="n">etaLead</span><span class="p">,</span> <span class="n">useSigNCfiles</span><span class="o">=</span><span class="n">useSigNCfiles</span><span class="p">)</span>
        <span class="n">SigR0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elecR</span><span class="o">.</span><span class="n">getSig</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">Bulk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Bulk</span><span class="p">,</span> <span class="n">ispin</span><span class="o">=</span><span class="n">ispin</span><span class="p">,</span> <span class="n">etaLead</span><span class="o">=</span><span class="n">etaLead</span><span class="p">,</span> <span class="n">useSigNCfiles</span><span class="o">=</span><span class="n">useSigNCfiles</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">FoldedL</span><span class="p">:</span>
            <span class="c1"># Fold down from nuoL0 to the device region</span>
            <span class="c1"># A11 A12     g11 g12    I 0</span>
            <span class="c1"># A21 A22  *  g21 g22  = 0 I -&gt;</span>
            <span class="c1"># g22 = (A22-A21.A11^-1.A12)^-1 -&gt;</span>
            <span class="c1"># Sigma = A21.A11^-1.A12          (tau=A12)</span>
            <span class="n">devEndL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">devEndL</span>
            <span class="c1"># Do folding</span>
            <span class="n">eSmH</span> <span class="o">=</span> <span class="n">ee</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">S0</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">H0</span>
            <span class="n">eSmHmS</span> <span class="o">=</span> <span class="n">eSmH</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">devEndL</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">devEndL</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bulk</span><span class="p">:</span>
                <span class="n">eSmHmS</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nuoL0</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">nuoL0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SigL0</span> <span class="c1"># SGF^1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">eSmHmS</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nuoL0</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">nuoL0</span><span class="p">]</span> <span class="o">=</span> <span class="n">eSmHmS</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nuoL0</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">nuoL0</span><span class="p">]</span><span class="o">-</span><span class="n">SigL0</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="n">eSmHmS</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">devSt</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">devSt</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">devEndL</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">taud</span> <span class="o">=</span> <span class="n">eSmHmS</span><span class="p">[</span><span class="n">devSt</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">devEndL</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">devSt</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">inv</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">eSmHmS</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">devSt</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">devSt</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">eSmHmS</span><span class="p">[</span><span class="n">devSt</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">devEndL</span><span class="p">,</span> <span class="n">devSt</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">devEndL</span><span class="p">]</span> <span class="o">=</span> <span class="n">eSmHmS</span><span class="p">[</span><span class="n">devSt</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">devEndL</span><span class="p">,</span> <span class="n">devSt</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">devEndL</span><span class="p">]</span><span class="o">-</span>\
                                                       <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">taud</span><span class="p">,</span> <span class="n">inv</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SigL</span> <span class="o">=</span> <span class="n">eSmH</span><span class="p">[</span><span class="n">devSt</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">devEndL</span><span class="p">,</span> <span class="n">devSt</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">devEndL</span><span class="p">]</span><span class="o">-</span><span class="n">eSmHmS</span><span class="p">[</span><span class="n">devSt</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">devEndL</span><span class="p">,</span> <span class="n">devSt</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">devEndL</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SigL</span> <span class="o">=</span> <span class="n">SigL0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GamL</span> <span class="o">=</span> <span class="mf">1.0j</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SigL</span><span class="o">-</span><span class="n">MM</span><span class="o">.</span><span class="n">dagger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SigL</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bulk</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">FoldedL</span><span class="p">:</span>
            <span class="c1"># Reverse sign since SigL is really SGF^-1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">GamL</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">GamL</span>
        <span class="n">AssertReal</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GamL</span><span class="p">),</span> <span class="s1">&#39;GamL&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">FoldedR</span><span class="p">:</span>
            <span class="c1"># Fold down from nuoR0 to the device region</span>
            <span class="n">devStR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">devStR</span>
            <span class="n">eSmH</span> <span class="o">=</span> <span class="n">ee</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">S0</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">H0</span>
            <span class="n">eSmHmS</span> <span class="o">=</span> <span class="n">eSmH</span><span class="p">[</span><span class="n">devStR</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">nuo0</span><span class="p">,</span> <span class="n">devStR</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">nuo0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">tmpnuo</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">eSmHmS</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bulk</span><span class="p">:</span>
                <span class="n">eSmHmS</span><span class="p">[</span><span class="n">tmpnuo</span><span class="o">-</span><span class="n">nuoR0</span><span class="p">:</span><span class="n">tmpnuo</span><span class="p">,</span> <span class="n">tmpnuo</span><span class="o">-</span><span class="n">nuoR0</span><span class="p">:</span><span class="n">tmpnuo</span><span class="p">]</span> <span class="o">=</span> <span class="n">SigR0</span> <span class="c1"># SGF^1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">eSmHmS</span><span class="p">[</span><span class="n">tmpnuo</span><span class="o">-</span><span class="n">nuoR0</span><span class="p">:</span><span class="n">tmpnuo</span><span class="p">,</span> <span class="n">tmpnuo</span><span class="o">-</span><span class="n">nuoR0</span><span class="p">:</span><span class="n">tmpnuo</span><span class="p">]</span> <span class="o">=</span> <span class="n">eSmHmS</span><span class="p">[</span><span class="n">tmpnuo</span><span class="o">-</span><span class="n">nuoR0</span><span class="p">:</span><span class="n">tmpnuo</span><span class="p">,</span> <span class="n">tmpnuo</span><span class="o">-</span><span class="n">nuoR0</span><span class="p">:</span><span class="n">tmpnuo</span><span class="p">]</span><span class="o">-</span><span class="n">SigR0</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="n">eSmHmS</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nuoR</span><span class="p">,</span> <span class="n">nuoR</span><span class="p">:</span><span class="n">tmpnuo</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">taud</span> <span class="o">=</span> <span class="n">eSmHmS</span><span class="p">[</span><span class="n">nuoR</span><span class="p">:</span><span class="n">tmpnuo</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">nuoR</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">inv</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">eSmHmS</span><span class="p">[</span><span class="n">nuoR</span><span class="p">:</span><span class="n">tmpnuo</span><span class="p">,</span> <span class="n">nuoR</span><span class="p">:</span><span class="n">tmpnuo</span><span class="p">])</span>
            <span class="n">eSmHmS</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nuoR</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">nuoR</span><span class="p">]</span> <span class="o">=</span> <span class="n">eSmHmS</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nuoR</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">nuoR</span><span class="p">]</span><span class="o">-</span><span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">inv</span><span class="p">,</span> <span class="n">taud</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SigR</span> <span class="o">=</span> <span class="n">eSmH</span><span class="p">[</span><span class="n">devStR</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">devEnd</span><span class="p">,</span> <span class="n">devStR</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">devEnd</span><span class="p">]</span><span class="o">-</span><span class="n">eSmHmS</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nuoR</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">nuoR</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SigR</span> <span class="o">=</span> <span class="n">SigR0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GamR</span> <span class="o">=</span> <span class="mf">1.0j</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SigR</span><span class="o">-</span><span class="n">MM</span><span class="o">.</span><span class="n">dagger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SigR</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bulk</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">FoldedR</span><span class="p">:</span>
            <span class="c1"># Reverse sign since SigR is really SGF^-1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">GamR</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">GamR</span>
        <span class="n">AssertReal</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GamR</span><span class="p">),</span> <span class="s1">&#39;GamR&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GF.calcGF"><a class="viewcode-back" href="../../api-gen/Inelastica.NEGF.html#Inelastica.NEGF.GF.calcGF">[docs]</a>    <span class="k">def</span> <span class="nf">calcGF</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ee</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">ispin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">etaLead</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">useSigNCfiles</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">SpectralCutoff</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="s2">&quot;Calculate GF etc at energy ee and 2d k-point&quot;</span>
        <span class="n">nuo</span><span class="p">,</span> <span class="n">nuoL</span><span class="p">,</span> <span class="n">nuoR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuoL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuoR</span>
        <span class="n">nuo0</span><span class="p">,</span> <span class="n">nuoL0</span><span class="p">,</span> <span class="n">nuoR0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuo0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuoL0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuoR0</span>
        <span class="n">FoldedL</span><span class="p">,</span> <span class="n">FoldedR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FoldedL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FoldedR</span>
        <span class="n">devSt</span><span class="p">,</span> <span class="n">devEnd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DeviceOrbs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">DeviceOrbs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Determine whether electrode self-energies should be k-sampled or not</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elecL</span><span class="o">.</span><span class="n">mesh</span> <span class="c1"># a mesh was attached</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1"># Calculate electrode self-energies</span>
        <span class="k">if</span> <span class="n">mesh</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">SigAvg</span> <span class="c1"># Averaged self-energies exist</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">SigAvg</span> <span class="o">=</span> <span class="p">[</span><span class="bp">False</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">SigAvg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ee</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">SigAvg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">ispin</span><span class="p">:</span>
                <span class="c1"># We have already the averaged self-energies</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;NEGF: Reusing sampled electrode self-energies&#39;</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">Nk</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s1">&#39;for ispin= </span><span class="si">%i</span><span class="s1"> e= </span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ispin</span><span class="p">,</span> <span class="n">ee</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># k-sampling performed over folded electrode self-energies</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;NEGF: Sampling electrode self-energies&#39;</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">Nk</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s1">&#39;for ispin= </span><span class="si">%i</span><span class="s1"> e= </span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ispin</span><span class="p">,</span> <span class="n">ee</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calcSigLR</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">ispin</span><span class="p">,</span> <span class="n">etaLead</span><span class="p">,</span> <span class="n">useSigNCfiles</span><span class="p">,</span> <span class="n">SpectralCutoff</span><span class="p">)</span>
                <span class="n">AvgSigL</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">SigL</span>
                <span class="n">AvgSigR</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">SigR</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">k</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">calcSigLR</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">ispin</span><span class="p">,</span> <span class="n">etaLead</span><span class="p">,</span> <span class="n">useSigNCfiles</span><span class="p">,</span> <span class="n">SpectralCutoff</span><span class="p">)</span>
                    <span class="n">AvgSigL</span> <span class="o">+=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">SigL</span>
                    <span class="n">AvgSigR</span> <span class="o">+=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">SigR</span>
                <span class="c1"># We now simply continue with the averaged self-energies</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">SigL</span> <span class="o">=</span> <span class="n">AvgSigL</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">SigR</span> <span class="o">=</span> <span class="n">AvgSigR</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">SigAvg</span> <span class="o">=</span> <span class="p">[</span><span class="n">ee</span><span class="p">,</span> <span class="n">ispin</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># We sample k-points the usual way</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calcSigLR</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">ispin</span><span class="p">,</span> <span class="n">etaLead</span><span class="p">,</span> <span class="n">useSigNCfiles</span><span class="p">)</span>

        <span class="c1"># Ready to calculate Gr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setkpoint</span><span class="p">(</span><span class="n">kpoint</span><span class="p">,</span> <span class="n">ispin</span><span class="p">)</span>
        <span class="n">eSmH</span> <span class="o">=</span> <span class="n">ee</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span>
        <span class="k">if</span> <span class="n">FoldedL</span><span class="p">:</span>
            <span class="n">eSmH</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nuoL</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">nuoL</span><span class="p">]</span> <span class="o">=</span> <span class="n">eSmH</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nuoL</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">nuoL</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">SigL</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bulk</span><span class="p">:</span>
                <span class="n">eSmH</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nuoL</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">nuoL</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SigL</span> <span class="c1"># SGF^1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">eSmH</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nuoL</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">nuoL</span><span class="p">]</span> <span class="o">=</span> <span class="n">eSmH</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nuoL</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">nuoL</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">SigL</span>
        <span class="k">if</span> <span class="n">FoldedR</span><span class="p">:</span>
            <span class="n">eSmH</span><span class="p">[</span><span class="n">nuo</span><span class="o">-</span><span class="n">nuoR</span><span class="p">:</span><span class="n">nuo</span><span class="p">,</span> <span class="n">nuo</span><span class="o">-</span><span class="n">nuoR</span><span class="p">:</span><span class="n">nuo</span><span class="p">]</span> <span class="o">=</span> <span class="n">eSmH</span><span class="p">[</span><span class="n">nuo</span><span class="o">-</span><span class="n">nuoR</span><span class="p">:</span><span class="n">nuo</span><span class="p">,</span> <span class="n">nuo</span><span class="o">-</span><span class="n">nuoR</span><span class="p">:</span><span class="n">nuo</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">SigR</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bulk</span><span class="p">:</span>
                <span class="n">eSmH</span><span class="p">[</span><span class="n">nuo</span><span class="o">-</span><span class="n">nuoR</span><span class="p">:</span><span class="n">nuo</span><span class="p">,</span> <span class="n">nuo</span><span class="o">-</span><span class="n">nuoR</span><span class="p">:</span><span class="n">nuo</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SigR</span> <span class="c1"># SGF^1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">eSmH</span><span class="p">[</span><span class="n">nuo</span><span class="o">-</span><span class="n">nuoR</span><span class="p">:</span><span class="n">nuo</span><span class="p">,</span> <span class="n">nuo</span><span class="o">-</span><span class="n">nuoR</span><span class="p">:</span><span class="n">nuo</span><span class="p">]</span> <span class="o">=</span> <span class="n">eSmH</span><span class="p">[</span><span class="n">nuo</span><span class="o">-</span><span class="n">nuoR</span><span class="p">:</span><span class="n">nuo</span><span class="p">,</span> <span class="n">nuo</span><span class="o">-</span><span class="n">nuoR</span><span class="p">:</span><span class="n">nuo</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">SigR</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Gr</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">eSmH</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ga</span> <span class="o">=</span> <span class="n">MM</span><span class="o">.</span><span class="n">dagger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gr</span><span class="p">)</span>
        <span class="c1"># Calculate spectral functions</span>
        <span class="k">if</span> <span class="n">SpectralCutoff</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AL</span> <span class="o">=</span> <span class="n">MM</span><span class="o">.</span><span class="n">SpectralMatrix</span><span class="p">(</span><span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gr</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">nuoL</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">GamL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ga</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nuoL</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">cutoff</span><span class="o">=</span><span class="n">SpectralCutoff</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GamL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Gr</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nuoL</span><span class="p">,</span> <span class="p">:])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ALT</span> <span class="o">=</span> <span class="n">MM</span><span class="o">.</span><span class="n">SpectralMatrix</span><span class="p">(</span><span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ga</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">nuoL</span><span class="p">],</span> <span class="n">tmp</span><span class="p">),</span> <span class="n">cutoff</span><span class="o">=</span><span class="n">SpectralCutoff</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AR</span> <span class="o">=</span> <span class="n">MM</span><span class="o">.</span><span class="n">SpectralMatrix</span><span class="p">(</span><span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gr</span><span class="p">[:,</span> <span class="n">nuo</span><span class="o">-</span><span class="n">nuoR</span><span class="p">:</span><span class="n">nuo</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">GamR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ga</span><span class="p">[</span><span class="n">nuo</span><span class="o">-</span><span class="n">nuoR</span><span class="p">:</span><span class="n">nuo</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">cutoff</span><span class="o">=</span><span class="n">SpectralCutoff</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ARGLG</span> <span class="o">=</span> <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">AR</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AR</span><span class="o">.</span><span class="n">R</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">nuoL</span><span class="p">],</span> <span class="n">tmp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AL</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">AR</span>
            <span class="c1"># transmission matrix AL.GamR</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">TT</span> <span class="o">=</span> <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">AL</span><span class="o">.</span><span class="n">R</span><span class="p">[:,</span> <span class="n">nuo</span><span class="o">-</span><span class="n">nuoR</span><span class="p">:</span><span class="n">nuo</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">GamR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AL</span><span class="o">.</span><span class="n">L</span><span class="p">[</span><span class="n">nuo</span><span class="o">-</span><span class="n">nuoR</span><span class="p">:</span><span class="n">nuo</span><span class="p">,</span> <span class="p">:])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AL</span> <span class="o">=</span> <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gr</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">nuoL</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">GamL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ga</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nuoL</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GamL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Gr</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nuoL</span><span class="p">,</span> <span class="p">:])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ALT</span> <span class="o">=</span> <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ga</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">nuoL</span><span class="p">],</span> <span class="n">tmp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AR</span> <span class="o">=</span> <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gr</span><span class="p">[:,</span> <span class="n">nuo</span><span class="o">-</span><span class="n">nuoR</span><span class="p">:</span><span class="n">nuo</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">GamR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ga</span><span class="p">[</span><span class="n">nuo</span><span class="o">-</span><span class="n">nuoR</span><span class="p">:</span><span class="n">nuo</span><span class="p">,</span> <span class="p">:])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ARGLG</span> <span class="o">=</span> <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">AR</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">nuoL</span><span class="p">],</span> <span class="n">tmp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AL</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">AR</span>
            <span class="c1"># transmission matrix AL.GamR</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">TT</span> <span class="o">=</span> <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">AL</span><span class="p">[</span><span class="n">nuo</span><span class="o">-</span><span class="n">nuoR</span><span class="p">:</span><span class="n">nuo</span><span class="p">,</span> <span class="n">nuo</span><span class="o">-</span><span class="n">nuoR</span><span class="p">:</span><span class="n">nuo</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">GamR</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;NEGF.calcGF: Shape of transmission matrix (TT):&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TT</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;NEGF.calcGF: Energy and total transmission Tr[TT].real:&#39;</span><span class="p">,</span> <span class="n">ee</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TT</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
        <span class="c1"># Write also the Gammas in the full space of Gr/Ga/A</span>
        <span class="c1"># (needed for the inelastic shot noise)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GammaL</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gr</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GammaL</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nuoL</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">nuoL</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GamL</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GammaR</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gr</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GammaR</span><span class="p">[</span><span class="n">nuo</span><span class="o">-</span><span class="n">nuoR</span><span class="p">:</span><span class="n">nuo</span><span class="p">,</span> <span class="n">nuo</span><span class="o">-</span><span class="n">nuoR</span><span class="p">:</span><span class="n">nuo</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GamR</span></div>

<div class="viewcode-block" id="GF.setkpoint"><a class="viewcode-back" href="../../api-gen/Inelastica.NEGF.html#Inelastica.NEGF.GF.setkpoint">[docs]</a>    <span class="k">def</span> <span class="nf">setkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">ispin</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c1"># Initiate H, S to correct kpoint</span>
        <span class="n">nuo</span><span class="p">,</span> <span class="n">nuoL</span><span class="p">,</span> <span class="n">nuoR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuo0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuoL0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuoR0</span>

        <span class="n">kpoint3</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="n">kpoint3</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">kpoint</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">setkpoint</span><span class="p">(</span><span class="n">kpoint3</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="c1"># Remove PBC in z-direction</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">gamma</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">H0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">ispin</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">S0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># Remove direct left/right coupling</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">H0</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nuoL</span><span class="p">,</span> <span class="n">nuo</span><span class="o">-</span><span class="n">nuoR</span><span class="p">:</span><span class="n">nuo</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">H0</span><span class="p">[</span><span class="n">nuo</span><span class="o">-</span><span class="n">nuoR</span><span class="p">:</span><span class="n">nuo</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">nuoL</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">S0</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nuoL</span><span class="p">,</span> <span class="n">nuo</span><span class="o">-</span><span class="n">nuoR</span><span class="p">:</span><span class="n">nuo</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">S0</span><span class="p">[</span><span class="n">nuo</span><span class="o">-</span><span class="n">nuoR</span><span class="p">:</span><span class="n">nuo</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">nuoL</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Do trick with kz</span>
            <span class="n">tmpH</span><span class="p">,</span> <span class="n">tmpS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">ispin</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elecL</span><span class="o">.</span><span class="n">semiinf</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">elecR</span><span class="o">.</span><span class="n">semiinf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Periodicity along A1</span>
                <span class="k">if</span> <span class="n">kpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">kpoint3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Specified 2D k-point=&#39;</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Incompatible 2D k-point - use z as transport direction&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">elecL</span><span class="o">.</span><span class="n">semiinf</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">elecR</span><span class="o">.</span><span class="n">semiinf</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Periodicity along A1</span>
                <span class="k">if</span> <span class="n">kpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">kpoint3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Specified 2D k-point=&#39;</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Incompatible 2D k-point - use z as transport direction&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Default is along A3</span>
                <span class="n">kpoint3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">setkpoint</span><span class="p">(</span><span class="n">kpoint3</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">H0</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">tmpH</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">ispin</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">S0</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">tmpS</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">HS</span><span class="o">.</span><span class="n">S</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">FoldedL</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">FoldedR</span><span class="p">:</span>
            <span class="n">devSt</span><span class="p">,</span> <span class="n">devEnd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DeviceOrbs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">DeviceOrbs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H0</span><span class="p">[</span><span class="n">devSt</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">devEnd</span><span class="p">,</span> <span class="n">devSt</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">devEnd</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0</span><span class="p">[</span><span class="n">devSt</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">devEnd</span><span class="p">,</span> <span class="n">devSt</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">devEnd</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">OrthogonalDeviceRegion</span> <span class="o">=</span> <span class="bp">False</span></div>

<div class="viewcode-block" id="GF.calcTEIG"><a class="viewcode-back" href="../../api-gen/Inelastica.NEGF.html#Inelastica.NEGF.GF.calcTEIG">[docs]</a>    <span class="k">def</span> <span class="nf">calcTEIG</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="c1"># Transmission matrix (complex array)</span>
        <span class="n">TT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TT</span>
        <span class="n">Trans</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">TT</span><span class="p">)</span>
        <span class="n">VC</span><span class="o">.</span><span class="n">Check</span><span class="p">(</span><span class="s2">&quot;trans-imaginary-part&quot;</span><span class="p">,</span> <span class="n">Trans</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span>
                 <span class="s2">&quot;Transmission has large imaginary part&quot;</span><span class="p">)</span>
        <span class="c1"># Calculate eigenchannel transmissions too</span>
        <span class="n">tval</span><span class="p">,</span> <span class="n">tvec</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">TT</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">tval</span><span class="o">.</span><span class="n">real</span><span class="p">)</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># sort from largest to smallest</span>
        <span class="n">tval</span> <span class="o">=</span> <span class="n">tval</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">tvec</span> <span class="o">=</span> <span class="n">tvec</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span>
        <span class="c1"># Compute shot noise</span>
        <span class="n">Smat</span> <span class="o">=</span> <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">TT</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">TT</span><span class="p">))</span><span class="o">-</span><span class="n">TT</span><span class="p">)</span>
        <span class="n">sval</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">MM</span><span class="o">.</span><span class="n">dagger</span><span class="p">(</span><span class="n">tvec</span><span class="p">),</span> <span class="n">Smat</span><span class="p">,</span> <span class="n">tvec</span><span class="p">))</span>
        <span class="c1"># set up arrays</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">channels</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">SN</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">channels</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Trans</span><span class="o">.</span><span class="n">real</span>
        <span class="n">SN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">Smat</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">TT</span><span class="p">))):</span>
            <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tval</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">real</span>
            <span class="n">SN</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sval</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">real</span>
        <span class="k">return</span> <span class="n">T</span><span class="p">,</span> <span class="n">SN</span></div>

<div class="viewcode-block" id="GF.orthogonalize"><a class="viewcode-back" href="../../api-gen/Inelastica.NEGF.html#Inelastica.NEGF.GF.orthogonalize">[docs]</a>    <span class="k">def</span> <span class="nf">orthogonalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;NEGF.GF.orthogonalize: Orthogonalizing device region quantities&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OrthogonalDeviceRegion</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HNO</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># nonorthogonal device Hamiltonian (needed)</span>

        <span class="c1"># Device part</span>
        <span class="n">Usi</span> <span class="o">=</span> <span class="n">MM</span><span class="o">.</span><span class="n">mysqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">)</span> <span class="c1"># Folded S</span>
        <span class="n">Us</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Usi</span><span class="p">)</span>
        <span class="c1"># Store transformation matrices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Usi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Us</span> <span class="o">=</span> <span class="n">Usi</span><span class="p">,</span> <span class="n">Us</span>

        <span class="c1"># Transform S and H</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">Us</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="n">Us</span><span class="p">),</span> <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">Us</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="n">Us</span><span class="p">)</span>

        <span class="c1"># Sigmas/Gammas in pyTBT GF can be smaller than device region</span>
        <span class="c1"># First give them the shape of the device region</span>
        <span class="n">nnL</span><span class="p">,</span> <span class="n">nnR</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SigL</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SigR</span><span class="p">)</span>
        <span class="n">S1</span><span class="p">,</span> <span class="n">S2</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">complex</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
        <span class="n">S1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nnL</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">nnL</span><span class="p">],</span>  <span class="n">S2</span><span class="p">[</span><span class="o">-</span><span class="n">nnR</span><span class="p">:,</span> <span class="o">-</span><span class="n">nnR</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SigL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SigR</span>
        <span class="c1"># Resetting Sigmas to orthogonalized quantities</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SigL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SigR</span> <span class="o">=</span> <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">Us</span><span class="p">,</span> <span class="n">S1</span><span class="p">,</span> <span class="n">Us</span><span class="p">),</span> <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">Us</span><span class="p">,</span> <span class="n">S2</span><span class="p">,</span> <span class="n">Us</span><span class="p">)</span>
        <span class="c1"># ... now the same for the Gammas</span>
        <span class="n">G1</span><span class="p">,</span> <span class="n">G2</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">complex</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
        <span class="n">G1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nnL</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">nnL</span><span class="p">],</span>  <span class="n">G2</span><span class="p">[</span><span class="o">-</span><span class="n">nnR</span><span class="p">:,</span> <span class="o">-</span><span class="n">nnR</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GamL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">GamR</span>
        <span class="c1"># Resetting Gammas to orthogonalized quantities</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GamL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">GamR</span> <span class="o">=</span> <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">Us</span><span class="p">,</span> <span class="n">G1</span><span class="p">,</span> <span class="n">Us</span><span class="p">),</span> <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">Us</span><span class="p">,</span> <span class="n">G2</span><span class="p">,</span> <span class="n">Us</span><span class="p">)</span>

        <span class="c1"># Orthogonalize Greens functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Gr</span> <span class="o">=</span> <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">Usi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Gr</span><span class="p">,</span> <span class="n">Usi</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ga</span> <span class="o">=</span> <span class="n">MM</span><span class="o">.</span><span class="n">dagger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gr</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__calcEigChan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A1</span><span class="p">,</span> <span class="n">G2</span><span class="p">,</span> <span class="n">Left</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="c1"># Calculate Eigenchannels using recipe from PRB</span>
        <span class="c1"># For right eigenchannels, A1=A2, G2=G1 !!!</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">A1</span><span class="p">,</span> <span class="n">MM</span><span class="o">.</span><span class="n">SpectralMatrix</span><span class="p">):</span>
            <span class="n">ev</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">A1</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="n">A1</span><span class="o">.</span><span class="n">R</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ev</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">A1</span><span class="p">)</span>

        <span class="c1"># This small trick will remove all zero contribution vectors</span>
        <span class="c1"># and will diagonalize the tt matrix in the subspace where there</span>
        <span class="c1"># are values.</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">ev</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ev</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ev</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">N</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
        <span class="n">ev</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Utilde</span> <span class="o">=</span> <span class="n">ev</span> <span class="o">*</span> <span class="n">U</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span>

        <span class="n">nuo</span><span class="p">,</span> <span class="n">nuoL</span><span class="p">,</span> <span class="n">nuoR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuoL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuoR</span>
        <span class="k">if</span> <span class="n">Left</span><span class="p">:</span>
            <span class="n">tt</span> <span class="o">=</span> <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">MM</span><span class="o">.</span><span class="n">dagger</span><span class="p">(</span><span class="n">Utilde</span><span class="p">[</span><span class="n">nuo</span><span class="o">-</span><span class="n">nuoR</span><span class="p">:</span><span class="n">nuo</span><span class="p">,</span> <span class="p">:]),</span> <span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">G2</span><span class="p">,</span> <span class="n">Utilde</span><span class="p">[</span><span class="n">nuo</span><span class="o">-</span><span class="n">nuoR</span><span class="p">:</span><span class="n">nuo</span><span class="p">,</span> <span class="p">:])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tt</span> <span class="o">=</span> <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">MM</span><span class="o">.</span><span class="n">dagger</span><span class="p">(</span><span class="n">Utilde</span><span class="p">[:</span><span class="n">nuoL</span><span class="p">,</span> <span class="p">:]),</span> <span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">G2</span><span class="p">,</span> <span class="n">Utilde</span><span class="p">[:</span><span class="n">nuoL</span><span class="p">,</span> <span class="p">:])</span>

        <span class="c1"># Diagonalize (note that this is on a reduced tt matrix (no 0 contributing columns)</span>
        <span class="n">evF</span><span class="p">,</span> <span class="n">UF</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>
        <span class="n">EC</span> <span class="o">=</span> <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">Utilde</span><span class="p">,</span> <span class="n">UF</span><span class="p">[:,</span> <span class="o">-</span><span class="n">channels</span><span class="p">:])</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="n">EC</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">evF</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># reverse eigenvalues</span>

<div class="viewcode-block" id="GF.calcEigChan"><a class="viewcode-back" href="../../api-gen/Inelastica.NEGF.html#Inelastica.NEGF.GF.calcEigChan">[docs]</a>    <span class="k">def</span> <span class="nf">calcEigChan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="c1"># Calculate Eigenchannels from left</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ECleft</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">EigTleft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__calcEigChan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">AL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">GamR</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">channels</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;NEGF.calcEigChan: Left eigenchannel transmissions [T1, ..., Tn]:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">EigTleft</span><span class="p">[:</span><span class="n">channels</span><span class="p">])</span>
        <span class="c1"># Calculate Eigenchannels from right</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ECright</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">EigTright</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__calcEigChan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">AR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">GamL</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="n">channels</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;NEGF.calcEigChan: Right eigenchannel transmissions [T1, ..., Tn]:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">EigTright</span><span class="p">[:</span><span class="n">channels</span><span class="p">])</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2003-2018, Magnus Paulsson and Thomas Frederiksen.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'v1.3.6',
            LANGUAGE:'en',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>