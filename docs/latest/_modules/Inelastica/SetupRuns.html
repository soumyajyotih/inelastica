

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Inelastica.SetupRuns &mdash; Inelastica v1.3.6 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Inelastica
          

          
            
            <img src="../../_static/82px-Inelastica-logo-mini.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                v1.3.6
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scripts.html">Scripts</a></li>
</ul>
<p class="caption"><span class="caption-text">Publications</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../cite.html">Citing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../publications.html">Publications using Inelastica</a></li>
</ul>
<p class="caption"><span class="caption-text">API documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api-gen/Inelastica.html">Inelastica package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Inelastica</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>Inelastica.SetupRuns</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for Inelastica.SetupRuns</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">:mod:`Inelastica.SetupRuns`</span>
<span class="sd">===========================</span>

<span class="sd">Functions to setup (Tran)SIESTA calculation and submit pbs jobs.</span>

<span class="sd">* CG: Optimization including scaling of electrode distances</span>
<span class="sd">* FC: For phonon and e-ph calculations</span>
<span class="sd">* OS: only overlap (S) calculation used to obtain e-ph coupling</span>
<span class="sd">* PH: Phonon frequencies and e-ph coupling</span>
<span class="sd">* TS: Transiesta adding electrode layers to CG geometry</span>
<span class="sd">* IN: (not working at the moment)</span>

<span class="sd">The basic idea is to use an existing CG (geometry optimization) setup</span>
<span class="sd">to create all the other calculation directories needed.</span>

<span class="sd">.. currentmodule:: Inelastica.SetupRuns</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">netCDF4</span> <span class="kn">as</span> <span class="nn">NC4</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">N</span>
<span class="kn">import</span> <span class="nn">Inelastica.MakeGeom</span> <span class="kn">as</span> <span class="nn">MG</span>
<span class="kn">import</span> <span class="nn">Inelastica.physics.constants</span> <span class="kn">as</span> <span class="nn">PC</span>
<span class="kn">from</span> <span class="nn">Inelastica.io.siesta</span> <span class="kn">import</span> <span class="n">copy_chemical_info</span>


<span class="c1"># -----------------------------------------------------------------------------------------------------</span>
<span class="c1">#                                          SetupCGrun</span>
<span class="c1"># -----------------------------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="SetupCGrun"><a class="viewcode-back" href="../../api-gen/Inelastica.SetupRuns.html#Inelastica.SetupRuns.SetupCGrun">[docs]</a><span class="k">def</span> <span class="nf">SetupCGrun</span><span class="p">(</span><span class="n">templateCGrun</span><span class="p">,</span> <span class="n">newCGrun</span><span class="p">,</span> <span class="n">NewContactSeparation</span><span class="p">,</span> <span class="n">AtomsPerLayer</span><span class="p">,</span>
               <span class="n">IndexShift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ListL</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ListR</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ZmatRanges</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">RotationAngle</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">RotationCenter</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">RotationAxis</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">RotationSubset</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">overwrite</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">PBStemplate</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">PBSsubs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">submitJob</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    templateCGrun        : Path+foldername to a template CGrun folder which contain</span>
<span class="sd">                              the necessary SIESTA files and a structure which is to</span>
<span class="sd">                              be modified for a new electrode separation</span>
<span class="sd">                              (this function writes a new STRUCT.fdf file)</span>
<span class="sd">    newCGrun             : Path+foldername for the CGrun to be created</span>
<span class="sd">    NewContactSeparation : The new electrode separation in Ang (defined as the z-distance</span>
<span class="sd">                              over the device between two electrode layers which has not</span>
<span class="sd">                              been relaxed)</span>
<span class="sd">    AtomsPerLayer        : Number of atoms in one electrode layer in a cross-section wrt.</span>
<span class="sd">                              the transport direction</span>
<span class="sd">    IndexShift           : Number of atoms which is periodically translated from left to</span>
<span class="sd">                              right during the formation of the new STRUCT.fdf from the</span>
<span class="sd">                              template *.XV file</span>
<span class="sd">    ListL/ListR          : These atom indices (SIESTA numbering) are forced to be a part of</span>
<span class="sd">                              the electrodes and hence not affected by stretching</span>
<span class="sd">    RotationAngle/       : Rotate whole CG geometry (or only RotationSubset if specified)</span>
<span class="sd">    RotationCenter/           an angle RotationAngle (in degrees) around RotationAxis vector through</span>
<span class="sd">    RotationAxis/             atom index RotationCenter (SIESTA numbering). These manipulations</span>
<span class="sd">    RotationSubset            are implemented BEFORE electrode separation is adjusted.</span>
<span class="sd">    overwrite            : (True/False) Specifies if one is allowed to write in existing</span>
<span class="sd">                              directories</span>
<span class="sd">    PBStemplate          : Path+foldername to a template RUN.pbs file for PBS queueing</span>
<span class="sd">    PBSsubs              : A list of string substitutions to be applied to the template</span>
<span class="sd">                              PBS script in order to generate a new PBS script</span>
<span class="sd">                              (e.g., PBSsubs=[[&#39;JOBNAME&#39;,&#39;newjobname&#39;],...]&#39; will replace</span>
<span class="sd">                              any JOBNAME string with newjobname)</span>
<span class="sd">    submitJob            : (True/False) Submit to batch queue via qsub command?</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Make new directories</span>
    <span class="n">head</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">newCGrun</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">head</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SetupRuns.SetupCGrun: Creating folder </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">head</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">head</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">newCGrun</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SetupRuns.SetupCGrun: Creating folder </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">newCGrun</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">newCGrun</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SetupRuns.SetupCGrun: </span><span class="si">%s</span><span class="s1"> already exists. No further actions taken.&#39;</span>\
              <span class="o">%</span><span class="n">newCGrun</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span> <span class="c1"># Quit script</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SetupRuns.SetupCGrun: </span><span class="si">%s</span><span class="s1"> already exists. OVERWRITING FILES!!!&#39;</span>\
              <span class="o">%</span><span class="n">newCGrun</span><span class="p">)</span>
    <span class="c1"># Copy template files</span>
    <span class="n">CopyInputFiles</span><span class="p">(</span><span class="n">templateCGrun</span><span class="p">,</span> <span class="n">newCGrun</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;.fdf&#39;</span><span class="p">,</span> <span class="s1">&#39;.vps&#39;</span><span class="p">,</span> <span class="s1">&#39;.psf&#39;</span><span class="p">,</span> <span class="s1">&#39;pbs&#39;</span><span class="p">,</span> <span class="s1">&#39;.TSHS&#39;</span><span class="p">])</span>
    <span class="c1"># Read relaxed geometry</span>
    <span class="n">XVfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">templateCGrun</span><span class="o">+</span><span class="s1">&#39;/*.XV*&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">XVfiles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">geom</span> <span class="o">=</span> <span class="n">MG</span><span class="o">.</span><span class="n">Geom</span><span class="p">(</span><span class="n">XVfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">XVfiles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;More than one XV file was found in folder </span><span class="si">%s</span><span class="s1">:&#39;</span><span class="o">%</span><span class="n">templateCGrun</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xvfile</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">XVfiles</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;   No. </span><span class="si">%i</span><span class="s1"> :&#39;</span><span class="o">%</span><span class="n">i</span><span class="p">,</span> <span class="n">xvfile</span><span class="p">)</span>
        <span class="n">select</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;   ... select file:&#39;</span><span class="p">)</span>
        <span class="n">geom</span> <span class="o">=</span> <span class="n">MG</span><span class="o">.</span><span class="n">Geom</span><span class="p">(</span><span class="n">XVfiles</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">select</span><span class="p">)])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;No XV file was found in folder </span><span class="si">%s</span><span class="s1">:&#39;</span><span class="o">%</span><span class="n">templateCGrun</span><span class="p">)</span>
        <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;   ... Continue reading geometry from RUN.fdf?&#39;</span><span class="p">)</span>
        <span class="n">geom</span> <span class="o">=</span> <span class="n">MG</span><span class="o">.</span><span class="n">Geom</span><span class="p">(</span><span class="n">templateCGrun</span><span class="o">+</span><span class="s1">&#39;/RUN.fdf&#39;</span><span class="p">)</span>
    <span class="c1"># Rotate via indexshift?</span>
    <span class="k">if</span> <span class="n">IndexShift</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;SetupRuns.SetupCGrun: Applying IndexShift =&#39;</span><span class="p">,</span> <span class="n">IndexShift</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">IndexShift</span><span class="p">):</span>
            <span class="n">geom</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">geom</span><span class="o">.</span><span class="n">pbc</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">geom</span><span class="o">.</span><span class="n">addAtom</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">geom</span><span class="o">.</span><span class="n">snr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">geom</span><span class="o">.</span><span class="n">anr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">geom</span><span class="o">.</span><span class="n">rmAtom</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Rotation?</span>
    <span class="k">if</span> <span class="n">RotationAngle</span> <span class="ow">and</span> <span class="n">RotationCenter</span> <span class="ow">and</span> <span class="n">RotationAxis</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;SetupRuns.SetupCGrun: Rotation applied:&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;   ... Rotation angle  =&#39;</span><span class="p">,</span> <span class="n">RotationAngle</span><span class="p">,</span> <span class="s1">&#39; deg&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;   ... Rotation center = atom </span><span class="si">%i</span><span class="s1"> (SIESTA numbering)&#39;</span><span class="o">%</span><span class="n">RotationCenter</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;   ... Rotation axis   =&#39;</span><span class="p">,</span> <span class="n">RotationAxis</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">RotationSubset</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;   ... RotationSubset  =&#39;</span><span class="p">,</span> <span class="n">RotationSubset</span><span class="p">,</span> <span class="s1">&#39; (SIESTA numbering)&#39;</span><span class="p">)</span>
            <span class="c1"># Change from SIESTA numbering to Python indices</span>
            <span class="n">RotationSubset</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">RotationSubset</span><span class="p">]</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">RotationCenter</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">geom</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">RotationAxis</span><span class="p">,</span> <span class="n">RotationAngle</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">RotateSubset</span><span class="o">=</span><span class="n">RotationSubset</span><span class="p">)</span>
    <span class="c1"># Adjust electrode separation</span>
    <span class="k">if</span> <span class="n">NewContactSeparation</span><span class="p">:</span>
        <span class="n">geom</span><span class="o">.</span><span class="n">stretch2NewContactSeparation</span><span class="p">(</span><span class="n">NewContactSeparation</span><span class="p">,</span> <span class="n">AtomsPerLayer</span><span class="p">,</span> <span class="n">ListL</span><span class="o">=</span><span class="n">ListL</span><span class="p">,</span> <span class="n">ListR</span><span class="o">=</span><span class="n">ListR</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ZmatRanges</span><span class="p">:</span>
        <span class="n">geom</span><span class="o">.</span><span class="n">writeFDF</span><span class="p">(</span><span class="n">newCGrun</span><span class="o">+</span><span class="s1">&#39;/STRUCT.fdf&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">geom</span><span class="o">.</span><span class="n">writeFDFZmat</span><span class="p">(</span><span class="n">newCGrun</span><span class="o">+</span><span class="s1">&#39;/STRUCT.fdf&#39;</span><span class="p">,</span> <span class="n">ZmatRanges</span><span class="p">)</span>
    <span class="n">geom</span><span class="o">.</span><span class="n">writeXYZ</span><span class="p">(</span><span class="n">newCGrun</span><span class="o">+</span><span class="s1">&#39;/STRUCT.xyz&#39;</span><span class="p">)</span>
    <span class="n">geom</span><span class="o">.</span><span class="n">writeXYZ</span><span class="p">(</span><span class="n">newCGrun</span><span class="o">+</span><span class="s1">&#39;/STRUCT2.xyz&#39;</span><span class="p">,</span> <span class="n">rep</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="c1"># PBS files</span>
    <span class="n">MakePBS</span><span class="p">(</span><span class="n">PBStemplate</span><span class="p">,</span> <span class="n">newCGrun</span><span class="o">+</span><span class="s1">&#39;/RUN.pbs&#39;</span><span class="p">,</span> <span class="n">PBSsubs</span><span class="p">,</span> <span class="n">submitJob</span><span class="p">,</span> <span class="n">rtype</span><span class="o">=</span><span class="s1">&#39;TS&#39;</span><span class="p">)</span></div>


<span class="c1"># -----------------------------------------------------------------------------------------------------</span>
<span class="c1">#                                          SetupFCrun</span>
<span class="c1"># -----------------------------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="SetupFCrun"><a class="viewcode-back" href="../../api-gen/Inelastica.SetupRuns.html#Inelastica.SetupRuns.SetupFCrun">[docs]</a><span class="k">def</span> <span class="nf">SetupFCrun</span><span class="p">(</span><span class="n">CGrun</span><span class="p">,</span> <span class="n">newFCrun</span><span class="p">,</span> <span class="n">FCfirst</span><span class="p">,</span> <span class="n">FClast</span><span class="p">,</span> <span class="n">displacement</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span>
               <span class="n">overwrite</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">PBStemplate</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">PBSsubs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">submitJob</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
               <span class="n">main_fdf</span><span class="o">=</span><span class="s2">&quot;RUN.fdf&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CGrun                : Path+foldername to a relaxed structure CGrun folder on</span>
<span class="sd">                              which to perform a FCrun calculation. This folder must</span>
<span class="sd">                              contain an *.XV file</span>
<span class="sd">    newFCrun             : Path+foldername for the FCrun to be created</span>
<span class="sd">    FCfirst              : Number of the first atom to displace (SIESTA numbering)</span>
<span class="sd">    FClast               : Number of the last atom to displace (SIESTA numbering)</span>
<span class="sd">    displacement         : Displacement</span>
<span class="sd">    overwrite            : (True/False) Specifies if one is allowed to write in existing</span>
<span class="sd">                              directories</span>
<span class="sd">    PBStemplate          : Path+foldername to a template RUN.pbs file for PBS queueing</span>
<span class="sd">    PBSsubs              : A list of string substitutions to be applied to the template</span>
<span class="sd">                              PBS script in order to generate a new PBS script</span>
<span class="sd">                              (e.g., PBSsubs=[[&#39;JOBNAME&#39;,&#39;newjobname&#39;],...]&#39; will replace</span>
<span class="sd">                              any JOBNAME string with newjobname)</span>
<span class="sd">    submitJob            : (True/False) Submit to batch queue via qsub command?</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Make new directory</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">newFCrun</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SetupRuns.SetupFCrun: Creating folder </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">newFCrun</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">newFCrun</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SetupRuns.SetupFCrun: </span><span class="si">%s</span><span class="s1"> already exists. No further actions taken.&#39;</span>\
              <span class="o">%</span><span class="n">newFCrun</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span> <span class="c1"># Quit script</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SetupRuns.SetupFCrun: </span><span class="si">%s</span><span class="s1"> already exists. OVERWRITING FILES!!!&#39;</span>\
              <span class="o">%</span><span class="n">newFCrun</span><span class="p">)</span>
    <span class="c1"># Copy template files</span>
    <span class="n">CopyInputFiles</span><span class="p">(</span><span class="n">CGrun</span><span class="p">,</span> <span class="n">newFCrun</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;.fdf&#39;</span><span class="p">,</span> <span class="s1">&#39;.vps&#39;</span><span class="p">,</span> <span class="s1">&#39;.psf&#39;</span><span class="p">,</span> <span class="s1">&#39;.DM&#39;</span><span class="p">,</span> <span class="s1">&#39;.XV&#39;</span><span class="p">,</span> <span class="s1">&#39;.pbs&#39;</span><span class="p">,</span> <span class="s1">&#39;.TSDE&#39;</span><span class="p">,</span> <span class="s1">&#39;.TSHS&#39;</span><span class="p">])</span>
    <span class="c1"># Read relaxed geometry and overwrite STRUCT files</span>
    <span class="n">XVfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">CGrun</span><span class="o">+</span><span class="s1">&#39;/*.XV*&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">XVfiles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">geom</span> <span class="o">=</span> <span class="n">MG</span><span class="o">.</span><span class="n">Geom</span><span class="p">(</span><span class="n">XVfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">XVfiles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;More than one XV file was found in folder </span><span class="si">%s</span><span class="s1">:&#39;</span><span class="o">%</span><span class="n">CGrun</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xvfile</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">XVfiles</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;   No. </span><span class="si">%i</span><span class="s1"> :&#39;</span><span class="o">%</span><span class="n">i</span><span class="p">,</span> <span class="n">xvfile</span><span class="p">)</span>
        <span class="n">select</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;   ... select file:&#39;</span><span class="p">)</span>
        <span class="n">geom</span> <span class="o">=</span> <span class="n">MG</span><span class="o">.</span><span class="n">Geom</span><span class="p">(</span><span class="n">XVfiles</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">select</span><span class="p">)])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;No XV file was found in folder </span><span class="si">%s</span><span class="s1">:&#39;</span><span class="o">%</span><span class="n">CGrun</span><span class="p">)</span>
        <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;   ... Continue reading geometry from RUN.fdf?&#39;</span><span class="p">)</span>
        <span class="n">geom</span> <span class="o">=</span> <span class="n">MG</span><span class="o">.</span><span class="n">Geom</span><span class="p">(</span><span class="n">CGrun</span><span class="o">+</span><span class="s1">&#39;/RUN.fdf&#39;</span><span class="p">)</span>
    <span class="n">geom</span><span class="o">.</span><span class="n">writeFDF</span><span class="p">(</span><span class="n">newFCrun</span><span class="o">+</span><span class="s1">&#39;/STRUCT.fdf&#39;</span><span class="p">)</span>
    <span class="n">geom</span><span class="o">.</span><span class="n">writeXYZ</span><span class="p">(</span><span class="n">newFCrun</span><span class="o">+</span><span class="s1">&#39;/STRUCT.xyz&#39;</span><span class="p">)</span>
    <span class="n">geom</span><span class="o">.</span><span class="n">writeXYZ</span><span class="p">(</span><span class="n">newFCrun</span><span class="o">+</span><span class="s1">&#39;/STRUCT2.xyz&#39;</span><span class="p">,</span> <span class="n">rep</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">CGrun</span><span class="o">+</span><span class="s2">&quot;/STRUCT.fdf&quot;</span><span class="p">):</span>
        <span class="n">copy_chemical_info</span><span class="p">(</span><span class="n">CGrun</span><span class="o">+</span><span class="s2">&quot;/STRUCT.fdf&quot;</span><span class="p">,</span> <span class="n">newFCrun</span><span class="o">+</span><span class="s2">&quot;/STRUCT.fdf&quot;</span><span class="p">)</span>

    <span class="c1"># Prepend lines to RUN.fdf</span>
    <span class="n">elm</span> <span class="o">=</span> <span class="n">newFCrun</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">main_fdf</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">elm</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;SetupRuns.SetupFCrun: Modifying </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">elm</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">elm</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">elm</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;### Lines appended </span><span class="si">%s</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">())</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;MD.TypeOfRun  FC</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;MD.FCfirst   </span><span class="si">%i</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">FCfirst</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;MD.FClast    </span><span class="si">%i</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">FClast</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;TS.HS.Save True</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;TS.SaveHS    True</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;MD.FCDispl   </span><span class="si">%.8f</span><span class="s1"> Ang</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">displacement</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{} was not found, so it cannot be edited.&quot;</span>
              <span class="s2">&quot;Rerun with main_fdf set correctly.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">elm</span><span class="p">))</span>
    <span class="c1"># PBS files</span>
    <span class="n">MakePBS</span><span class="p">(</span><span class="n">PBStemplate</span><span class="p">,</span> <span class="n">newFCrun</span><span class="o">+</span><span class="s1">&#39;/RUN.pbs&#39;</span><span class="p">,</span> <span class="n">PBSsubs</span><span class="p">,</span> <span class="n">submitJob</span><span class="p">,</span> <span class="n">rtype</span><span class="o">=</span><span class="s1">&#39;TS&#39;</span><span class="p">)</span></div>


<span class="c1"># -----------------------------------------------------------------------------------------------------</span>
<span class="c1">#                                          SetupOSrun</span>
<span class="c1"># -----------------------------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="SetupOSrun"><a class="viewcode-back" href="../../api-gen/Inelastica.SetupRuns.html#Inelastica.SetupRuns.SetupOSrun">[docs]</a><span class="k">def</span> <span class="nf">SetupOSrun</span><span class="p">(</span><span class="n">CGrun</span><span class="p">,</span> <span class="n">newOSrun</span><span class="p">,</span> <span class="n">displacement</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">main_fdf</span><span class="o">=</span><span class="s2">&quot;RUN.fdf&quot;</span><span class="p">,</span>
               <span class="n">overwrite</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">PBStemplate</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">PBSsubs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">submitJob</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CGrun                : Path+foldername to a relaxed structure CGrun folder on</span>
<span class="sd">                              which to run an onlyS calculation. This folder must</span>
<span class="sd">                              contain an *.XV file</span>
<span class="sd">    newOSrun             : Path+foldername for the onlyS folder to be created</span>
<span class="sd">    displacement         : Displacement used in the FCrun displacements</span>
<span class="sd">    overwrite            : (True/False) Specifies if one is allowed to write in existing</span>
<span class="sd">                              directories</span>
<span class="sd">    PBStemplate          : Path+foldername to a template RUN.pbs file for PBS queueing</span>
<span class="sd">    PBSsubs              : A list of string substitutions to be applied to the template</span>
<span class="sd">                              PBS script in order to generate a new PBS script</span>
<span class="sd">                              (e.g., PBSsubs=[[&#39;JOBNAME&#39;,&#39;newjobname&#39;],...]&#39; will replace</span>
<span class="sd">                              any JOBNAME string with newjobname)</span>
<span class="sd">    submitJob            : (True/False) Submit to batch queue via qsub command?</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Make new directory</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">newOSrun</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SetupRuns.SetupOSrun: Creating folder </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">newOSrun</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">newOSrun</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SetupRuns.SetupOSrun: </span><span class="si">%s</span><span class="s1"> already exists. No further actions taken.&#39;</span>\
              <span class="o">%</span><span class="n">newOSrun</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span> <span class="c1"># Quit script</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SetupRuns.SetupOSrun: </span><span class="si">%s</span><span class="s1"> already exists. OVERWRITING FILES!!!&#39;</span>\
              <span class="o">%</span><span class="n">newOSrun</span><span class="p">)</span>
    <span class="c1"># Copy files from CGrun</span>
    <span class="n">CopyInputFiles</span><span class="p">(</span><span class="n">CGrun</span><span class="p">,</span> <span class="n">newOSrun</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;.fdf&#39;</span><span class="p">,</span> <span class="s1">&#39;.vps&#39;</span><span class="p">,</span> <span class="s1">&#39;.psf&#39;</span><span class="p">])</span>
    <span class="c1"># Read original RUN.fdf file</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">newOSrun</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">main_fdf</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c1"># Read relaxed geometry</span>
    <span class="n">XVfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">CGrun</span><span class="o">+</span><span class="s1">&#39;/*.XV*&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">XVfiles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">infile</span> <span class="o">=</span> <span class="n">XVfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">XVfiles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;More than one XV file was found in folder </span><span class="si">%s</span><span class="s1">:&#39;</span><span class="o">%</span><span class="n">CGrun</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xvfile</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">XVfiles</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;   No. </span><span class="si">%i</span><span class="s1"> :&#39;</span><span class="o">%</span><span class="n">i</span><span class="p">,</span> <span class="n">xvfile</span><span class="p">)</span>
        <span class="n">select</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;   ... select file:&#39;</span><span class="p">)</span>
        <span class="n">infile</span> <span class="o">=</span> <span class="n">XVfiles</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">select</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;No XV file was found in folder </span><span class="si">%s</span><span class="s1">:&#39;</span><span class="o">%</span><span class="n">CGrun</span><span class="p">)</span>
        <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;   ... Continue reading geometry from RUN.fdf?&#39;</span><span class="p">)</span>
        <span class="n">infile</span> <span class="o">=</span> <span class="n">CGrun</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">main_fdf</span>
    <span class="c1"># Multiply structure</span>
    <span class="n">BuildOSstruct</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">newOSrun</span><span class="o">+</span><span class="s1">&#39;/STRUCT_1.fdf&#39;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">direction</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">displacement</span><span class="o">=</span><span class="n">displacement</span><span class="p">)</span>
    <span class="n">BuildOSstruct</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">newOSrun</span><span class="o">+</span><span class="s1">&#39;/STRUCT_2.fdf&#39;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">direction</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">displacement</span><span class="o">=</span><span class="n">displacement</span><span class="p">)</span>
    <span class="n">BuildOSstruct</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">newOSrun</span><span class="o">+</span><span class="s1">&#39;/STRUCT_3.fdf&#39;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">direction</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">displacement</span><span class="o">=</span><span class="n">displacement</span><span class="p">)</span>
    <span class="n">BuildOSstruct</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">newOSrun</span><span class="o">+</span><span class="s1">&#39;/STRUCT_4.fdf&#39;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">direction</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">displacement</span><span class="o">=</span><span class="n">displacement</span><span class="p">)</span>
    <span class="n">BuildOSstruct</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">newOSrun</span><span class="o">+</span><span class="s1">&#39;/STRUCT_5.fdf&#39;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">direction</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">displacement</span><span class="o">=</span><span class="n">displacement</span><span class="p">)</span>
    <span class="n">BuildOSstruct</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">newOSrun</span><span class="o">+</span><span class="s1">&#39;/STRUCT_6.fdf&#39;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">direction</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">displacement</span><span class="o">=</span><span class="n">displacement</span><span class="p">)</span>
    <span class="n">structfiles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;STRUCT_1.fdf&#39;</span><span class="p">,</span> <span class="s1">&#39;STRUCT_2.fdf&#39;</span><span class="p">,</span> <span class="s1">&#39;STRUCT_3.fdf&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;STRUCT_4.fdf&#39;</span><span class="p">,</span> <span class="s1">&#39;STRUCT_5.fdf&#39;</span><span class="p">,</span> <span class="s1">&#39;STRUCT_6.fdf&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">CGrun</span><span class="o">+</span><span class="s2">&quot;/STRUCT.fdf&quot;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">struct</span> <span class="ow">in</span> <span class="n">structfiles</span><span class="p">:</span>
            <span class="n">copy_chemical_info</span><span class="p">(</span><span class="n">CGrun</span><span class="o">+</span><span class="s2">&quot;/STRUCT.fdf&quot;</span><span class="p">,</span> <span class="n">newOSrun</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">struct</span><span class="p">)</span>
    <span class="n">inputfiles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RUN_1.fdf&#39;</span><span class="p">,</span> <span class="s1">&#39;RUN_2.fdf&#39;</span><span class="p">,</span> <span class="s1">&#39;RUN_3.fdf&#39;</span><span class="p">,</span> <span class="s1">&#39;RUN_4.fdf&#39;</span><span class="p">,</span> <span class="s1">&#39;RUN_5.fdf&#39;</span><span class="p">,</span> <span class="s1">&#39;RUN_6.fdf&#39;</span><span class="p">]</span>
    <span class="c1"># Write input files</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">inputfile</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inputfiles</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;SetupRuns.SetupOSrun: Writing </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">newOSrun</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">inputfile</span><span class="p">))</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">((</span><span class="n">newOSrun</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">inputfile</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;### Lines written </span><span class="si">%s</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">())</span>
        <span class="c1"># Ensure we don&#39;t get lua errors...</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;MD.TypeOfRun CG&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="c1">#f.write(&#39;MD.NumCGSteps 0\n&#39;)</span>
        <span class="c1">#f.write(&#39;DM.NumberPulay 0 \n&#39;)</span>
        <span class="c1">#f.write(&#39;MPN.onlyS .true.\n\n&#39;)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;TS.onlyS .true.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;TS.S.save true</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;SystemName STRUCT_</span><span class="si">%i</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;SystemLabel STRUCT_</span><span class="si">%i</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">nclude &#39;</span><span class="o">+</span><span class="s1">&#39;./STRUCT_</span><span class="si">%i</span><span class="s1">.fdf</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;### Lines from RUN.fdf </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;STRUCT.fdf&#39;</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">nclude &#39;</span><span class="o">+</span><span class="n">structfiles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c1"># PBS files</span>
    <span class="n">MakePBS</span><span class="p">(</span><span class="n">PBStemplate</span><span class="p">,</span> <span class="n">newOSrun</span><span class="o">+</span><span class="s1">&#39;/RUN.pbs&#39;</span><span class="p">,</span> <span class="n">PBSsubs</span><span class="p">,</span> <span class="n">submitJob</span><span class="p">,</span> <span class="n">rtype</span><span class="o">=</span><span class="s1">&#39;OS&#39;</span><span class="p">)</span></div>


<span class="c1"># -----------------------------------------------------------------------------------------------------</span>
<span class="c1">#                                          SetupTSrun</span>
<span class="c1"># -----------------------------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="SetupTSrun"><a class="viewcode-back" href="../../api-gen/Inelastica.SetupRuns.html#Inelastica.SetupRuns.SetupTSrun">[docs]</a><span class="k">def</span> <span class="nf">SetupTSrun</span><span class="p">(</span><span class="n">CGrun</span><span class="p">,</span> <span class="n">templateTSrun</span><span class="p">,</span> <span class="n">newTSrun</span><span class="p">,</span>
               <span class="n">AtomsPerLayer</span><span class="p">,</span> <span class="n">BlockSize</span><span class="p">,</span> <span class="n">LayersLeft</span><span class="p">,</span> <span class="n">LayersRight</span><span class="p">,</span>
               <span class="n">DeviceLayerInclLeft</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">DeviceLayerInclRight</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">IndexShift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
               <span class="n">AddLeftList</span><span class="o">=</span><span class="p">[],</span> <span class="n">AddRightList</span><span class="o">=</span><span class="p">[],</span> <span class="n">ListL</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ListR</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">NewContactSeparation</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">RotationAngle</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">RotationCenter</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">RotationAxis</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">RotationSubset</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">overwrite</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">PBStemplate</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">PBSsubs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">submitJob</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    CGrun                : Path+foldername to a relaxed structure CGrun folder on</span>
<span class="sd">                              which to run a TranSIESTA calculation. This folder must</span>
<span class="sd">                              contain an *.XV file</span>
<span class="sd">    templateTSrun        : Path+foldername to an existing TSrun folder which contains</span>
<span class="sd">                              all relevant electrode calculations and *.fdf files</span>
<span class="sd">                              except for STRUCT.fdf</span>
<span class="sd">    newTSrun             : Path+foldername for the TSrun folder to be created</span>
<span class="sd">    AtomsPerLayer        : Number of atoms in the electrodes in a cross section along</span>
<span class="sd">                              the transport direction</span>
<span class="sd">    BlockSize            : Number of atoms in the electrode block from CGrun/*.XV file</span>
<span class="sd">    LayersLeft/Right     : Number of blocks to be pasted to the new enlarged STRUCT.fdf.</span>
<span class="sd">    DeviceLayerInclLeft  : As default TBTRANS takes all relaxed atoms to be the device</span>
<span class="sd">                              If DeviceLayerInclLeft is larger than 0 then TBTRANS</span>
<span class="sd">                              includes the specified number of electode atomic planes into</span>
<span class="sd">                              the device region.</span>
<span class="sd">    DeviceLayerInclRight : See DeviceLayerInclLeft</span>
<span class="sd">    IndexShift           : Number of atoms which is periodically translated from left to</span>
<span class="sd">                              right contact BEFORE eventual electrode layers are pasted.</span>
<span class="sd">    AddLeftList          : Add list of atoms to the left side</span>
<span class="sd">    AddRightList         : Add list of atoms to the right side</span>
<span class="sd">    ListL/ListR          : These atom indices (SIESTA numbering) are forced to be a part of</span>
<span class="sd">                              the electrodes and hence not affected by stretching</span>
<span class="sd">    NewContactSeparation : (Optional) value to set a different electrode separation</span>
<span class="sd">                              than in the CG geometry</span>
<span class="sd">    RotationAngle/       : Rotate whole CG geometry (or only RotationSubset if specified)</span>
<span class="sd">    RotationCenter/           an angle RotationAngle (in degrees) around RotationAxis vector through</span>
<span class="sd">    RotationAxis/             atom index RotationCenter (SIESTA numbering). These manipulations</span>
<span class="sd">    RotationSubset            are implemented BEFORE electrode separation is adjusted.</span>
<span class="sd">    overwrite            : (True/False) Specifies if one is allowed to write in existing</span>
<span class="sd">                              directories</span>
<span class="sd">    PBStemplate          : Path+foldername to a template RUN.pbs file for PBS queueing</span>
<span class="sd">    PBSsubs              : A list of string substitutions to be applied to the template</span>
<span class="sd">                              PBS script in order to generate a new PBS script</span>
<span class="sd">                              (e.g., PBSsubs=[[&#39;JOBNAME&#39;,&#39;newjobname&#39;],...]&#39; will replace</span>
<span class="sd">                              any JOBNAME string with newjobname)</span>
<span class="sd">    submitJob            : (True/False) Submit to batch queue via qsub command?</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Make new directory</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">newTSrun</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SetupRuns.SetupTSrun: Creating folder </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">newTSrun</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">newTSrun</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SetupRuns.SetupTSrun: </span><span class="si">%s</span><span class="s1"> already exists. No further actions taken.&#39;</span>\
              <span class="o">%</span><span class="n">newTSrun</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span> <span class="c1"># Quit script</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SetupRuns.SetupTSrun: </span><span class="si">%s</span><span class="s1"> already exists. OVERWRITING FILES!!!&#39;</span>\
              <span class="o">%</span><span class="n">newTSrun</span><span class="p">)</span>
    <span class="c1"># Copy all sub-directories</span>
    <span class="k">for</span> <span class="n">elm</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">templateTSrun</span><span class="o">+</span><span class="s1">&#39;/*&#39;</span><span class="p">):</span>
        <span class="n">tail</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">elm</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">elm</span><span class="p">):</span>
            <span class="n">CopyTree</span><span class="p">(</span><span class="n">elm</span><span class="p">,</span> <span class="n">newTSrun</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">tail</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
    <span class="c1"># Copy template files</span>
    <span class="n">CopyInputFiles</span><span class="p">(</span><span class="n">templateTSrun</span><span class="p">,</span> <span class="n">newTSrun</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;.fdf&#39;</span><span class="p">,</span> <span class="s1">&#39;.vps&#39;</span><span class="p">,</span> <span class="s1">&#39;.psf&#39;</span><span class="p">,</span> <span class="s1">&#39;.pbs&#39;</span><span class="p">])</span>
    <span class="c1"># Read relaxed geometry</span>
    <span class="n">XVfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">CGrun</span><span class="o">+</span><span class="s1">&#39;/*.XV*&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">XVfiles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">geom</span> <span class="o">=</span> <span class="n">MG</span><span class="o">.</span><span class="n">Geom</span><span class="p">(</span><span class="n">XVfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">XVfiles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;More than one XV file was found in folder </span><span class="si">%s</span><span class="s1">:&#39;</span><span class="o">%</span><span class="n">CGrun</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xvfile</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">XVfiles</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;   No. </span><span class="si">%i</span><span class="s1"> :&#39;</span><span class="o">%</span><span class="n">i</span><span class="p">,</span> <span class="n">xvfile</span><span class="p">)</span>
        <span class="n">select</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;   ... select file:&#39;</span><span class="p">)</span>
        <span class="n">geom</span> <span class="o">=</span> <span class="n">MG</span><span class="o">.</span><span class="n">Geom</span><span class="p">(</span><span class="n">XVfiles</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">select</span><span class="p">)])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;No XV file was found in folder </span><span class="si">%s</span><span class="s1">:&#39;</span><span class="o">%</span><span class="n">CGrun</span><span class="p">)</span>
        <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;   ... Continue reading geometry from RUN.fdf?&#39;</span><span class="p">)</span>
        <span class="n">geom</span> <span class="o">=</span> <span class="n">MG</span><span class="o">.</span><span class="n">Geom</span><span class="p">(</span><span class="n">CGrun</span><span class="o">+</span><span class="s1">&#39;/RUN.fdf&#39;</span><span class="p">)</span>
    <span class="c1"># Rotate via indexshift?</span>
    <span class="k">if</span> <span class="n">IndexShift</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;SetupRuns.SetupTSrun: Applying IndexShift =&#39;</span><span class="p">,</span> <span class="n">IndexShift</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">IndexShift</span><span class="p">):</span>
            <span class="n">geom</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">geom</span><span class="o">.</span><span class="n">pbc</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">geom</span><span class="o">.</span><span class="n">addAtom</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">geom</span><span class="o">.</span><span class="n">snr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">geom</span><span class="o">.</span><span class="n">anr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">geom</span><span class="o">.</span><span class="n">rmAtom</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Overwrite STRUCT files</span>
    <span class="k">if</span> <span class="n">RotationAngle</span> <span class="ow">and</span> <span class="n">RotationCenter</span> <span class="ow">and</span> <span class="n">RotationAxis</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;SetupRuns.SetupTSrun: Rotation applied:&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;   ... Rotation angle  =&#39;</span><span class="p">,</span> <span class="n">RotationAngle</span><span class="p">,</span> <span class="s1">&#39; deg&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;   ... Rotation center = atom </span><span class="si">%i</span><span class="s1"> (SIESTA numbering)&#39;</span><span class="o">%</span><span class="n">RotationCenter</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;   ... Rotation axis   =&#39;</span><span class="p">,</span> <span class="n">RotationAxis</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">RotationSubset</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;   ... RotationSubset  =&#39;</span><span class="p">,</span> <span class="n">RotationSubset</span><span class="p">,</span> <span class="s1">&#39; (SIESTA numbering)&#39;</span><span class="p">)</span>
            <span class="c1"># Change from SIESTA numbering to Python indices</span>
            <span class="n">RotationSubset</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">RotationSubset</span><span class="p">]</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">RotationCenter</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">geom</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">RotationAxis</span><span class="p">,</span> <span class="n">RotationAngle</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">RotateSubset</span><span class="o">=</span><span class="n">RotationSubset</span><span class="p">)</span>
    <span class="c1"># Paste electrode layers via BlockSize specifications</span>
    <span class="n">geom</span><span class="o">.</span><span class="n">PasteElectrodeLayers</span><span class="p">(</span><span class="n">BlockSize</span><span class="p">,</span> <span class="n">AtomsPerLayer</span><span class="p">,</span> <span class="n">LayersLeft</span><span class="p">,</span> <span class="n">LayersRight</span><span class="p">)</span>
    <span class="c1"># Change contact separation?</span>
    <span class="k">if</span> <span class="n">NewContactSeparation</span><span class="p">:</span>
        <span class="n">geom</span><span class="o">.</span><span class="n">stretch2NewContactSeparation</span><span class="p">(</span><span class="n">NewContactSeparation</span><span class="p">,</span> <span class="n">AtomsPerLayer</span><span class="p">,</span> <span class="n">ListL</span><span class="o">=</span><span class="n">ListL</span><span class="p">,</span> <span class="n">ListR</span><span class="o">=</span><span class="n">ListR</span><span class="p">)</span>
    <span class="c1"># Add electrode atoms to the left</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">AddLeftList</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">dz</span> <span class="o">=</span> <span class="n">AddLeftList</span><span class="p">[</span><span class="n">AtomsPerLayer</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">AddLeftList</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">xyz</span><span class="p">)</span>
        <span class="n">minz</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tmp</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">maxz</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">AddLeftList</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">AddLeftList</span><span class="p">)))):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">AddLeftList</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span><span class="o">+</span><span class="p">(</span><span class="o">-</span><span class="n">maxz</span><span class="o">+</span><span class="n">minz</span><span class="o">-</span><span class="n">dz</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">))</span>
            <span class="n">geom</span><span class="o">.</span><span class="n">prependAtom</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span>
                         <span class="n">geom</span><span class="o">.</span><span class="n">snr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">geom</span><span class="o">.</span><span class="n">anr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">geom</span><span class="o">.</span><span class="n">pbc</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">AddLeftList</span><span class="p">)</span><span class="o">/</span><span class="n">AtomsPerLayer</span><span class="o">*</span><span class="n">dz</span>
    <span class="c1"># Add electrode atoms to the right</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">AddRightList</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">dz</span> <span class="o">=</span> <span class="n">AddRightList</span><span class="p">[</span><span class="n">AtomsPerLayer</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">AddRightList</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">xyz</span><span class="p">)</span>
        <span class="n">maxz</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">dz</span><span class="o">+</span><span class="n">geom</span><span class="o">.</span><span class="n">pbc</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">minz</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">AddRightList</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">AddRightList</span><span class="p">)):</span>
            <span class="n">geom</span><span class="o">.</span><span class="n">addAtom</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">AddRightList</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span><span class="o">+</span>
                              <span class="p">(</span><span class="n">maxz</span><span class="o">-</span><span class="n">minz</span><span class="o">+</span><span class="n">dz</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">)),</span>
                         <span class="n">geom</span><span class="o">.</span><span class="n">snr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">geom</span><span class="o">.</span><span class="n">anr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">geom</span><span class="o">.</span><span class="n">pbc</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">AddRightList</span><span class="p">)</span><span class="o">/</span><span class="n">AtomsPerLayer</span><span class="o">*</span><span class="n">dz</span>
    <span class="c1"># Write structure to files</span>
    <span class="n">geom</span><span class="o">.</span><span class="n">writeFDF</span><span class="p">(</span><span class="n">newTSrun</span><span class="o">+</span><span class="s1">&#39;/STRUCT.fdf&#39;</span><span class="p">)</span>
    <span class="n">geom</span><span class="o">.</span><span class="n">writeXYZ</span><span class="p">(</span><span class="n">newTSrun</span><span class="o">+</span><span class="s1">&#39;/STRUCT.xyz&#39;</span><span class="p">)</span>
    <span class="n">geom</span><span class="o">.</span><span class="n">writeXYZ</span><span class="p">(</span><span class="n">newTSrun</span><span class="o">+</span><span class="s1">&#39;/STRUCT2.xyz&#39;</span><span class="p">,</span> <span class="n">rep</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="c1"># Find device atoms</span>
    <span class="n">geom</span><span class="o">.</span><span class="n">findContactsAndDevice</span><span class="p">(</span><span class="n">AtomsPerLayer</span><span class="p">)</span>
    <span class="n">PDOSfirst</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">deviceList</span><span class="p">)</span><span class="o">-</span><span class="n">DeviceLayerInclLeft</span><span class="o">*</span><span class="n">AtomsPerLayer</span>
    <span class="n">PDOSlast</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">deviceList</span><span class="p">)</span><span class="o">+</span><span class="n">DeviceLayerInclRight</span><span class="o">*</span><span class="n">AtomsPerLayer</span>
    <span class="c1"># Prepend lines to TBTRANS.fdf</span>
    <span class="k">for</span> <span class="n">elm</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">newTSrun</span><span class="o">+</span><span class="s1">&#39;/TBTRANS.fdf&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">elm</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;SetupRuns.SetupTSrun: Prepending PDOS = [</span><span class="si">%i</span><span class="s1">,</span><span class="si">%i</span><span class="s1">] to </span><span class="si">%s</span><span class="s1">&#39;</span> \
                  <span class="o">%</span><span class="p">(</span><span class="n">PDOSfirst</span><span class="p">,</span> <span class="n">PDOSlast</span><span class="p">,</span> <span class="n">elm</span><span class="p">))</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">elm</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">elm</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;### Lines appended </span><span class="si">%s</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">())</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;TS.TBT.PDOSFrom   </span><span class="si">%i</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">PDOSfirst</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;TS.TBT.PDOSTo     </span><span class="si">%i</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">PDOSlast</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c1"># PBS files</span>
    <span class="n">MakePBS</span><span class="p">(</span><span class="n">PBStemplate</span><span class="p">,</span> <span class="n">newTSrun</span><span class="o">+</span><span class="s1">&#39;/RUN.pbs&#39;</span><span class="p">,</span> <span class="n">PBSsubs</span><span class="p">,</span> <span class="n">submitJob</span><span class="p">,</span> <span class="n">rtype</span><span class="o">=</span><span class="s1">&#39;TS&#39;</span><span class="p">)</span></div>


<span class="c1"># -----------------------------------------------------------------------------------------------------</span>
<span class="c1">#                                          RunTBT</span>
<span class="c1"># -----------------------------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="RunTBT"><a class="viewcode-back" href="../../api-gen/Inelastica.SetupRuns.html#Inelastica.SetupRuns.RunTBT">[docs]</a><span class="k">def</span> <span class="nf">RunTBT</span><span class="p">(</span><span class="n">TSrun</span><span class="p">,</span> <span class="n">Emin</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">NPoints</span><span class="p">,</span> <span class="n">NumKxy_A1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">NumKxy_A2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
           <span class="n">AtomsPerLayer</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">DeviceLayerInclLeft</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">DeviceLayerInclRight</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
           <span class="n">PBStemplate</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">PBSsubs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">submitJob</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    PBStemplate          : Path+foldername to a template RUN.pbs file for PBS queueing</span>
<span class="sd">    PBSsubs              : A list of string substitutions to be applied to the template</span>
<span class="sd">                              PBS script in order to generate a new PBS script</span>
<span class="sd">                              (e.g., PBSsubs=[[&#39;JOBNAME&#39;,&#39;newjobname&#39;],...] will replace</span>
<span class="sd">                              any JOBNAME string with newjobname)</span>
<span class="sd">    submitJob            : (True/False) Submit to batch queue via qsub command?</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Remove old Green&#39;s functions</span>
    <span class="k">for</span> <span class="n">elm</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">TSrun</span><span class="o">+</span><span class="s1">&#39;/*GF&#39;</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;SetupRuns.RunTBT: Removing *.GF&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">elm</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;   Deleting </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">elm</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">elm</span><span class="p">)</span>
    <span class="c1"># Determine Device PDOS?</span>
    <span class="k">if</span> <span class="n">AtomsPerLayer</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">elm</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">TSrun</span><span class="o">+</span><span class="s1">&#39;/*XV&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">elm</span><span class="p">):</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="n">MG</span><span class="o">.</span><span class="n">Geom</span><span class="p">(</span><span class="n">elm</span><span class="p">)</span>
                <span class="n">geom</span><span class="o">.</span><span class="n">findContactsAndDevice</span><span class="p">(</span><span class="n">AtomsPerLayer</span><span class="p">)</span>
                <span class="n">PDOSfirst</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">deviceList</span><span class="p">)</span><span class="o">-</span><span class="n">DeviceLayerInclLeft</span><span class="o">*</span><span class="n">AtomsPerLayer</span>
                <span class="n">PDOSlast</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">deviceList</span><span class="p">)</span><span class="o">+</span><span class="n">DeviceLayerInclRight</span><span class="o">*</span><span class="n">AtomsPerLayer</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">PDOSfirst</span><span class="p">,</span> <span class="n">PDOSlast</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="c1"># Prepend lines to TBTRANS.fdf</span>
    <span class="n">tbtfile</span> <span class="o">=</span> <span class="n">TSrun</span><span class="o">+</span><span class="s1">&#39;/TBTRANS.fdf&#39;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">tbtfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">tbtfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;### Lines appended </span><span class="si">%s</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">PDOSfirst</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">PDOSlast</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;SetupRuns.RunTBT: Prepending PDOS = [</span><span class="si">%i</span><span class="s1">,</span><span class="si">%i</span><span class="s1">] to </span><span class="si">%s</span><span class="s1">&#39;</span> \
            <span class="o">%</span><span class="p">(</span><span class="n">PDOSfirst</span><span class="p">,</span> <span class="n">PDOSlast</span><span class="p">,</span> <span class="n">tbtfile</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;TS.TBT.PDOSFrom   </span><span class="si">%i</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">PDOSfirst</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;TS.TBT.PDOSTo     </span><span class="si">%i</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">PDOSlast</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;SetupRuns.RunTBT: Writing Emin=</span><span class="si">%f</span><span class="s1">, Emax=</span><span class="si">%f</span><span class="s1">, NPoints=</span><span class="si">%i</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> \
        <span class="o">%</span><span class="p">(</span><span class="n">Emin</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">NPoints</span><span class="p">,</span> <span class="n">tbtfile</span><span class="p">))</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;TS.TBT.Emin       </span><span class="si">%f</span><span class="s1">  eV</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">Emin</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;TS.TBT.Emax       </span><span class="si">%f</span><span class="s1">  eV</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">Emax</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;TS.TBT.NPoints    </span><span class="si">%i</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">NPoints</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;TS.NumKxy_A1      </span><span class="si">%i</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">NumKxy_A1</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;TS.NumKxy_A2      </span><span class="si">%i</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">NumKxy_A2</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;pyTBT.K_A1        </span><span class="si">%i</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">NumKxy_A1</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;pyTBT.K_A2        </span><span class="si">%i</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">NumKxy_A2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c1"># PBS files</span>
    <span class="n">MakePBS</span><span class="p">(</span><span class="n">PBStemplate</span><span class="p">,</span> <span class="n">newTSrun</span><span class="o">+</span><span class="s1">&#39;/RUN.pyTBT.pbs&#39;</span><span class="p">,</span> <span class="n">PBSsubs</span><span class="p">,</span> <span class="n">submitJob</span><span class="p">,</span> <span class="n">rtype</span><span class="o">=</span><span class="s1">&#39;PY&#39;</span><span class="p">)</span></div>


<span class="c1"># -----------------------------------------------------------------------------------------------------</span>
<span class="c1">#                                          SetupPHrun</span>
<span class="c1"># -----------------------------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="SetupPHrun"><a class="viewcode-back" href="../../api-gen/Inelastica.SetupRuns.html#Inelastica.SetupRuns.SetupPHrun">[docs]</a><span class="k">def</span> <span class="nf">SetupPHrun</span><span class="p">(</span><span class="n">newPHrun</span><span class="p">,</span> <span class="n">wildcard</span><span class="p">,</span> <span class="n">onlySdir</span><span class="o">=</span><span class="s1">&#39;../OSrun&#39;</span><span class="p">,</span>
               <span class="n">DeviceFirst</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">DeviceLast</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span> <span class="n">FCfirst</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">FClast</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span>
               <span class="n">CalcCoupl</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">outlabel</span><span class="o">=</span><span class="s1">&#39;Out&#39;</span><span class="p">,</span>
               <span class="n">PerBoundCorrFirst</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">PerBoundCorrLast</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
               <span class="n">PrintSOrbitals</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">AuxNCfile</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
               <span class="n">overwrite</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">PBStemplate</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">PBSsubs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">submitJob</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    wildcard             : Path+wildcard used in the search for FCrun folders</span>
<span class="sd">    onlySdir             : Path+foldername to the relevant onlyS directory</span>
<span class="sd">    DeviceFirst/Last     : SIESTA atom numbers for the first/last atom to be included</span>
<span class="sd">                              in the device region (subspace of the Hamiltonian etc.)</span>
<span class="sd">    FCfirst/last         : SIESTA atom numbers for the first/last atom to be allowed</span>
<span class="sd">                              to move in the phonon calculation</span>
<span class="sd">    PerBoundCorrFirst/   : Optional argument to be passed to Phonons.py script</span>
<span class="sd">    PerBoundCorrLast</span>
<span class="sd">    PrintSOrbitals       : Optional argument to be passed to Phonons.py script</span>
<span class="sd">    AuxNCfile            : Optional argument to be passed to Phonons.py script</span>
<span class="sd">    overwrite            : (True/False) Specifies if one is allowed to write in existing</span>
<span class="sd">                              directories</span>
<span class="sd">    PBStemplate          : Path+foldername to a template RUN.pbs file for PBS queueing</span>
<span class="sd">    PBSsubs              : A list of string substitutions to be applied to the template</span>
<span class="sd">                              PBS script in order to generate a new PBS script</span>
<span class="sd">                              (e.g., PBSsubs=[[&#39;JOBNAME&#39;,&#39;newjobname&#39;],...]&#39; will replace</span>
<span class="sd">                              any JOBNAME string with newjobname)</span>
<span class="sd">    submitJob            : (True/False) Submit to batch queue via qsub command?</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">### Make directory for output files etc.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">newPHrun</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;SetupRuns.SetupPHrun: Creating&#39;</span><span class="p">,</span> <span class="n">newPHrun</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">newPHrun</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Error: directory already exist &quot;</span><span class="p">,</span> <span class="n">newPHrun</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># find device?</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;SetupRuns.SetupPHrun: Writing&#39;</span><span class="p">,</span> <span class="n">newPHrun</span><span class="o">+</span><span class="s1">&#39;/PHrun.py&#39;</span><span class="p">)</span>
    <span class="n">phfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">newPHrun</span><span class="o">+</span><span class="s1">&#39;/PHrun.py&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">phfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;from Inelastica.Phonons import *</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">phfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Analyze(FCwildcard=</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">,onlySdir=</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">,</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">wildcard</span><span class="p">,</span> <span class="n">onlySdir</span><span class="p">))</span>
    <span class="n">phfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;        DeviceFirst=</span><span class="si">%s</span><span class="s1">,DeviceLast=</span><span class="si">%s</span><span class="s1">,</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">DeviceFirst</span><span class="p">,</span> <span class="n">DeviceLast</span><span class="p">))</span>
    <span class="n">phfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;        FCfirst=</span><span class="si">%s</span><span class="s1">,FClast=</span><span class="si">%s</span><span class="s1">,</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">FCfirst</span><span class="p">,</span> <span class="n">FClast</span><span class="p">))</span>
    <span class="n">phfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;        outlabel=</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">outlabel</span><span class="p">)</span>
    <span class="n">phfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;        CalcCoupl=</span><span class="si">%s</span><span class="s1">,</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">CalcCoupl</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">AuxNCfile</span><span class="p">:</span>
        <span class="n">phfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;        AuxNCfile=</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">,</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">AuxNCfile</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">phfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;        AuxNCfile=False,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">phfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;        PerBoundCorrFirst=</span><span class="si">%i</span><span class="s1">,PerBoundCorrLast=</span><span class="si">%i</span><span class="s1">,</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="o">%</span><span class="p">(</span><span class="n">PerBoundCorrFirst</span><span class="p">,</span> <span class="n">PerBoundCorrLast</span><span class="p">))</span>
    <span class="n">phfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;        PrintSOrbitals=</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span><span class="n">PrintSOrbitals</span><span class="p">)</span>
    <span class="n">phfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># write WritePythonPBS(...)</span>
    <span class="c1"># PBS files</span>
    <span class="k">if</span> <span class="n">PBSsubs</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">PBSsubs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">PBSsubs</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;$PYTHONSCRIPT$&#39;</span><span class="p">,</span> <span class="s1">&#39;PHrun.py&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="n">PBSsubs</span>
    <span class="n">MakePBS</span><span class="p">(</span><span class="n">PBStemplate</span><span class="p">,</span> <span class="n">newPHrun</span><span class="o">+</span><span class="s1">&#39;/RUN.pbs&#39;</span><span class="p">,</span> <span class="n">PBSsubs</span><span class="p">,</span> <span class="n">submitJob</span><span class="p">,</span> <span class="n">rtype</span><span class="o">=</span><span class="s1">&#39;PY&#39;</span><span class="p">)</span></div>


<span class="c1"># -----------------------------------------------------------------------------------------------------</span>
<span class="c1">#                                          SetupInelastica</span>
<span class="c1"># -----------------------------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="SetupInelastica"><a class="viewcode-back" href="../../api-gen/Inelastica.SetupRuns.html#Inelastica.SetupRuns.SetupInelastica">[docs]</a><span class="k">def</span> <span class="nf">SetupInelastica</span><span class="p">(</span><span class="n">templateInelastica</span><span class="p">,</span> <span class="n">newInelastica</span><span class="p">,</span> <span class="n">TSrun</span><span class="p">,</span>
                    <span class="n">templateInputFile</span><span class="p">,</span> <span class="n">newInputFilename</span><span class="p">,</span> <span class="n">PhononNCfile</span><span class="p">,</span>
                    <span class="n">kPoints</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">overwrite</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">PBStemplate</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">PBSsubs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">submitJob</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    templateInelastica   : Path+foldername to the latest version of Inelastica</span>
<span class="sd">    newInelastica        : Path+foldername for the Inelastica folder to be created</span>
<span class="sd">    TSrun                : Path+foldername to the TSrun where TBTRANS outputs &#39;HSSigmaLR.nc&#39;</span>
<span class="sd">    templateInputFile    : Path+filename to an Inelastica input file which holds all</span>
<span class="sd">                              input variables except for the references to</span>
<span class="sd">                              RunThis.ncfile_e and RunThis.ncfile_ph (which are appended</span>
<span class="sd">                              automatically)</span>
<span class="sd">    newInputFilename     : Filename for the Inelastica input file to be created in folder</span>
<span class="sd">                              newInelastica with the above references appended</span>
<span class="sd">    PhononNCfile         : Path+filename to the NetCDF-file with phonon modes and couplings</span>
<span class="sd">                              (RunThis.ncfile_ph)</span>
<span class="sd">    kPoints              : Number of k-points written by TBTrans</span>
<span class="sd">    overwrite            : (True/False) Specifies if one is allowed to write in existing</span>
<span class="sd">                              directories</span>
<span class="sd">    PBStemplate          : Path+foldername to a template RUN.pbs file for PBS queueing</span>
<span class="sd">    PBSsubs              : A list of string substitutions to be applied to the template</span>
<span class="sd">                              PBS script in order to generate a new PBS script</span>
<span class="sd">                              (e.g., PBSsubs=[[&#39;JOBNAME&#39;,&#39;newjobname&#39;],...]&#39; will replace</span>
<span class="sd">                              any JOBNAME string with newjobname)</span>
<span class="sd">    submitJob            : (True/False) Submit to batch queue via qsub command?</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;SetupRuns.SetupInelastica: Creating&#39;</span><span class="p">,</span> <span class="n">newInelastica</span><span class="p">)</span>
    <span class="n">CopyTree</span><span class="p">(</span><span class="n">templateInelastica</span><span class="p">,</span> <span class="n">newInelastica</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">newInputFilename</span><span class="p">)</span>
    <span class="n">cmmd</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">kPoints</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">kPoints</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">inputfile</span> <span class="o">=</span> <span class="n">newInputFilename</span>
            <span class="n">TBT_NCfile</span> <span class="o">=</span> <span class="s1">&#39;/HSSigmaLR.nc&#39;</span>
            <span class="n">Mod_NCfile</span> <span class="o">=</span> <span class="s1">&#39;/HSSigmaLR_mod.nc&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inputfile</span> <span class="o">=</span> <span class="n">name</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">ext</span>
            <span class="n">TBT_NCfile</span> <span class="o">=</span> <span class="s1">&#39;/HSSigmaLR_</span><span class="si">%.3i</span><span class="s1">.nc&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">Mod_NCfile</span> <span class="o">=</span> <span class="s1">&#39;/HSSigmaLR_mod_</span><span class="si">%i</span><span class="s1">.nc&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Convert TBT nc-files to Inelastica folder</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">newInelastica</span><span class="o">+</span><span class="n">Mod_NCfile</span><span class="p">)</span> <span class="ow">or</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="n">UnitConvertTBOutput</span><span class="p">(</span><span class="n">TSrun</span><span class="o">+</span><span class="n">TBT_NCfile</span><span class="p">,</span> <span class="n">newInelastica</span><span class="o">+</span><span class="n">Mod_NCfile</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;SetupRuns.SetupInelastica: Creating&#39;</span><span class="p">,</span> <span class="n">newInelastica</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">inputfile</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">templateInputFile</span><span class="p">,</span> <span class="n">newInelastica</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">inputfile</span><span class="p">)</span>
        <span class="n">infile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">newInelastica</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">inputfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
        <span class="n">infile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"># AUTOMATICALLY APPENDED LINES: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">infile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;RunThis.ncfile_e    = </span><span class="se">\&#39;</span><span class="s1">.</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">Mod_NCfile</span><span class="p">)</span>
        <span class="n">infile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;RunThis.ncfile_ph    = </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">PhononNCfile</span><span class="p">)</span>
        <span class="n">infile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">cmmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;inelastica.py &#39;</span><span class="o">+</span><span class="n">inputfile</span><span class="o">+</span><span class="s1">&#39; -R&#39;</span><span class="p">)</span>
    <span class="c1"># PBS files</span>
    <span class="n">MakePBS</span><span class="p">(</span><span class="n">PBStemplate</span><span class="p">,</span> <span class="n">newInelastica</span><span class="o">+</span><span class="s1">&#39;/RUN.pbs&#39;</span><span class="p">,</span> <span class="n">PBSsubs</span><span class="p">,</span> <span class="n">submitJob</span><span class="p">,</span> <span class="n">rtype</span><span class="o">=</span><span class="s1">&#39;PY&#39;</span><span class="p">)</span></div>


<span class="c1"># -----------------------------------------------------------------------------------------------------</span>
<span class="c1">#                                          Auxiliary functions</span>
<span class="c1"># -----------------------------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="RemoveOutputFiles"><a class="viewcode-back" href="../../api-gen/Inelastica.SetupRuns.html#Inelastica.SetupRuns.RemoveOutputFiles">[docs]</a><span class="k">def</span> <span class="nf">RemoveOutputFiles</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">[],</span> <span class="n">DryRun</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">FullCleanup</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;SetupRuns.RemoveOutputFiles: Cleaning up </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">folder</span><span class="p">)</span>
    <span class="c1"># These suffixes can always be deleted</span>
    <span class="n">suffixes</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;.ion&#39;</span><span class="p">,</span> <span class="s1">&#39;.ion.xml&#39;</span><span class="p">,</span> <span class="s1">&#39;.POT.CONF&#39;</span><span class="p">,</span> <span class="s1">&#39;INPUT_TMP&#39;</span><span class="p">,</span> <span class="s1">&#39;out.fdf&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;.alloc&#39;</span><span class="p">,</span> <span class="s1">&#39;.Au_pbr&#39;</span><span class="p">,</span> <span class="s1">&#39;WALLTIME&#39;</span><span class="p">,</span> <span class="s1">&#39;fort.66&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;FDF_STDIN&#39;</span><span class="p">,</span> <span class="s1">&#39;.GF&#39;</span><span class="p">,</span> <span class="s1">&#39;.MD&#39;</span><span class="p">,</span> <span class="s1">&#39;.MDE&#39;</span><span class="p">,</span> <span class="s1">&#39;.VH&#39;</span><span class="p">,</span> <span class="s1">&#39;.VL&#39;</span><span class="p">,</span> <span class="s1">&#39;.VT&#39;</span><span class="p">]</span>
    <span class="c1"># [&#39;.HS&#39;,&#39;.ion.nc&#39;,&#39;.TSHS&#39;,&#39;.TSHS&#39;,&#39;.TSDE&#39;,&#39;.ANI&#39;,&#39;.DM&#39;,</span>
    <span class="c1">#  &#39;.EIG&#39;,&#39;.TEIG&#39;,&#39;.IEIG&#39;,&#39;.FC&#39;,&#39;.RHO&#39;,&#39;.DRHO&#39;,&#39;.nc&#39;]</span>
    <span class="k">for</span> <span class="n">elm</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">folder</span><span class="o">+</span><span class="s1">&#39;/*&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">suffixes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">elm</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">elm</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;   Deleting </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">elm</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">DryRun</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">elm</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">FullCleanup</span><span class="p">:</span>
        <span class="c1"># Remove all files except the input files</span>
        <span class="n">keepSuffixes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.fdf&#39;</span><span class="p">,</span> <span class="s1">&#39;.pbs&#39;</span><span class="p">,</span> <span class="s1">&#39;.log&#39;</span><span class="p">,</span> <span class="s1">&#39;.xyz&#39;</span><span class="p">,</span> <span class="s1">&#39;.XV&#39;</span><span class="p">,</span> <span class="s1">&#39;.vps&#39;</span><span class="p">,</span> <span class="s1">&#39;.psf&#39;</span><span class="p">,</span> <span class="s1">&#39;.py&#39;</span><span class="p">,</span> <span class="s1">&#39;.dat&#39;</span><span class="p">,</span> <span class="s1">&#39;.dat.nc&#39;</span><span class="p">,</span> <span class="s1">&#39;.freq&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">elm</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">folder</span><span class="o">+</span><span class="s1">&#39;/*&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">keepSuffixes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">elm</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">elm</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;   Keeping </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">elm</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;   Deleting </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">elm</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">DryRun</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">elm</span><span class="p">)</span>
                    <span class="k">break</span></div>


<div class="viewcode-block" id="ZipFolder"><a class="viewcode-back" href="../../api-gen/Inelastica.SetupRuns.html#Inelastica.SetupRuns.ZipFolder">[docs]</a><span class="k">def</span> <span class="nf">ZipFolder</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;SetupRuns: Zipping &#39;</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
    <span class="n">head</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
    <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">head</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;tar -cf tmp.tar </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">tail</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;gzip -c tmp.tar &gt; </span><span class="si">%s</span><span class="s1">.tar.gz&#39;</span><span class="o">%</span><span class="n">tail</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm tmp.tar&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -r </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">tail</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span></div>


<div class="viewcode-block" id="UnzipFolder"><a class="viewcode-back" href="../../api-gen/Inelastica.SetupRuns.html#Inelastica.SetupRuns.UnzipFolder">[docs]</a><span class="k">def</span> <span class="nf">UnzipFolder</span><span class="p">(</span><span class="n">zfile</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;SetupRuns: Unzipping&#39;</span><span class="p">,</span> <span class="n">zfile</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;gunzip </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">zfile</span><span class="p">)</span>
    <span class="n">head</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">zfile</span><span class="p">)</span>
    <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">head</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;tar -xf </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">tail</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">tail</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span></div>


<div class="viewcode-block" id="CopyInputFiles"><a class="viewcode-back" href="../../api-gen/Inelastica.SetupRuns.html#Inelastica.SetupRuns.CopyInputFiles">[docs]</a><span class="k">def</span> <span class="nf">CopyInputFiles</span><span class="p">(</span><span class="n">infolder</span><span class="p">,</span> <span class="n">outfolder</span><span class="p">,</span> <span class="n">suffixes</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;SetupRuns.CopyInputFiles:&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">elm</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">infolder</span><span class="o">+</span><span class="s1">&#39;/*&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">suffixes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">elm</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">elm</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;   </span><span class="si">%s</span><span class="s1">  --&gt;  </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">elm</span><span class="p">,</span> <span class="n">outfolder</span><span class="p">))</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">elm</span><span class="p">,</span> <span class="n">outfolder</span><span class="p">)</span></div>


<div class="viewcode-block" id="BuildOSstruct"><a class="viewcode-back" href="../../api-gen/Inelastica.SetupRuns.html#Inelastica.SetupRuns.BuildOSstruct">[docs]</a><span class="k">def</span> <span class="nf">BuildOSstruct</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">direction</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">displacement</span><span class="o">=</span><span class="mf">0.04</span><span class="o">*</span><span class="n">PC</span><span class="o">.</span><span class="n">Bohr2Ang</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;BuildOSstruct: displacement = </span><span class="si">%.6f</span><span class="s1"> Ang&#39;</span><span class="o">%</span><span class="n">displacement</span><span class="p">)</span>
    <span class="n">geom</span> <span class="o">=</span> <span class="n">MG</span><span class="o">.</span><span class="n">Geom</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">displdir</span> <span class="ow">in</span> <span class="n">direction</span><span class="p">:</span>
            <span class="n">new</span> <span class="o">=</span> <span class="n">MG</span><span class="o">.</span><span class="n">Geom</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
            <span class="n">displ</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]</span>
            <span class="n">displ</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">displdir</span><span class="o">*</span><span class="n">displacement</span>
            <span class="n">new</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">displ</span><span class="p">)</span>
            <span class="n">geom</span><span class="o">.</span><span class="n">addGeom</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
    <span class="n">geom</span><span class="o">.</span><span class="n">writeFDF</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span></div>


<div class="viewcode-block" id="CopyTree"><a class="viewcode-back" href="../../api-gen/Inelastica.SetupRuns.html#Inelastica.SetupRuns.CopyTree">[docs]</a><span class="k">def</span> <span class="nf">CopyTree</span><span class="p">(</span><span class="n">templateFolder</span><span class="p">,</span> <span class="n">newFolder</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="c1"># Make new directory</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">newFolder</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;SetupRuns.CopyTree: </span><span class="si">%s</span><span class="s1"> already exists. REMOVING EXISTING FOLDER!!!&#39;</span> <span class="o">%</span><span class="n">newFolder</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">newFolder</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;SetupRuns.CopyTree: </span><span class="si">%s</span><span class="s1"> already exists. No further actions taken.&#39;</span> <span class="o">%</span><span class="n">newFolder</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="c1"># Copy tree</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;SetupRuns.CopyTree: Copying&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;   </span><span class="si">%s</span><span class="s1">  --&gt;  </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">templateFolder</span><span class="p">,</span> <span class="n">newFolder</span><span class="p">))</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">templateFolder</span><span class="p">,</span> <span class="n">newFolder</span><span class="p">)</span></div>


<div class="viewcode-block" id="UnitConvertTBOutput"><a class="viewcode-back" href="../../api-gen/Inelastica.SetupRuns.html#Inelastica.SetupRuns.UnitConvertTBOutput">[docs]</a><span class="k">def</span> <span class="nf">UnitConvertTBOutput</span><span class="p">(</span><span class="n">TBncfile</span><span class="p">,</span> <span class="n">newTBncfile</span><span class="p">):</span>
    <span class="c1"># This function is copied from &quot;netcdf_transiestaInterpol.py&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;SetupRuns.UnitConvertTBOutput: </span><span class="si">%s</span><span class="s1">  --&gt;  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">TBncfile</span><span class="p">,</span> <span class="n">newTBncfile</span><span class="p">))</span>

    <span class="c1"># Read TBncfile (infile)</span>
    <span class="n">infile</span> <span class="o">=</span> <span class="n">NC4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">TBncfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">En</span> <span class="o">=</span> <span class="n">PC</span><span class="o">.</span><span class="n">Rydberg2eV</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">infile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;En&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">])</span> \
        <span class="o">+</span> <span class="mi">1j</span><span class="o">*</span><span class="n">PC</span><span class="o">.</span><span class="n">Rydberg2eV</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">infile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;En&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">PC</span><span class="o">.</span><span class="n">Rydberg2eV</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">infile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">][:])</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">infile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">][:])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ImH</span> <span class="o">=</span> <span class="n">PC</span><span class="o">.</span><span class="n">Rydberg2eV</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">infile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;ImH&#39;</span><span class="p">][:])</span>
        <span class="n">ImS</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">infile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;ImS&#39;</span><span class="p">][:])</span>
        <span class="n">ImHSexist</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">ImHSexist</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;UnitConvertTBOutput: No imaginary parts of H and S found.&#39;</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">En</span><span class="p">)</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>

    <span class="c1"># Write variables to newTBncfile (outfile)</span>
    <span class="n">outfile</span> <span class="o">=</span> <span class="n">NC4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">newTBncfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">outfile</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;TBtrans unit-converted output&quot;</span>
    <span class="n">outfile</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">outfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="c1"># Energy grid</span>
    <span class="n">outfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;flt&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># Float value</span>
    <span class="n">outfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;dim&#39;</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span> <span class="c1"># Problem dimension</span>
    <span class="n">H2</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;dim&#39;</span><span class="p">,</span> <span class="s1">&#39;dim&#39;</span><span class="p">))</span>
    <span class="n">H2</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">H</span>
    <span class="n">H2</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;eV&#39;</span>
    <span class="n">S2</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;dim&#39;</span><span class="p">,</span> <span class="s1">&#39;dim&#39;</span><span class="p">))</span>
    <span class="n">S2</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">S</span>
    <span class="n">S2</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
    <span class="k">if</span> <span class="n">ImHSexist</span><span class="p">:</span>
        <span class="n">ImH2</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;ImH&#39;</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;dim&#39;</span><span class="p">,</span> <span class="s1">&#39;dim&#39;</span><span class="p">))</span>
        <span class="n">ImH2</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">ImH</span>
        <span class="n">ImH2</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;eV&#39;</span>
        <span class="n">ImS2</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;ImS&#39;</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;dim&#39;</span><span class="p">,</span> <span class="s1">&#39;dim&#39;</span><span class="p">))</span>
        <span class="n">ImS2</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">ImS</span>
        <span class="n">ImS2</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;ReEn&#39;</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,))</span>
    <span class="n">tmp</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">En</span><span class="o">.</span><span class="n">real</span>
    <span class="n">tmp</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;eV&#39;</span>
    <span class="n">tmp2</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;ImEn&#39;</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,))</span>
    <span class="n">tmp2</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">En</span><span class="o">.</span><span class="n">imag</span>
    <span class="n">tmp2</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;eV&#39;</span>
    <span class="n">ReSigmaL</span> <span class="o">=</span> <span class="n">PC</span><span class="o">.</span><span class="n">Rydberg2eV</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">infile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;ReSigmaL&#39;</span><span class="p">][:])</span>
    <span class="n">ReSigmaL2</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;ReSigmaL&#39;</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;dim&#39;</span><span class="p">,</span> <span class="s1">&#39;dim&#39;</span><span class="p">))</span>
    <span class="n">ReSigmaL2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">ReSigmaL</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="n">ReSigmaL2</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;eV&#39;</span>
    <span class="n">ReSigmaL</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ImSigmaL</span> <span class="o">=</span> <span class="n">PC</span><span class="o">.</span><span class="n">Rydberg2eV</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">infile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;ImSigmaL&#39;</span><span class="p">][:])</span>
    <span class="n">ImSigmaL2</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;ImSigmaL&#39;</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;dim&#39;</span><span class="p">,</span> <span class="s1">&#39;dim&#39;</span><span class="p">))</span>
    <span class="n">ImSigmaL2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">ImSigmaL</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="n">ImSigmaL2</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;eV&#39;</span>
    <span class="n">ImSigmaL</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ReSigmaR</span> <span class="o">=</span> <span class="n">PC</span><span class="o">.</span><span class="n">Rydberg2eV</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">infile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;ReSigmaR&#39;</span><span class="p">][:])</span>
    <span class="n">ReSigmaR2</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;ReSigmaR&#39;</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;dim&#39;</span><span class="p">,</span> <span class="s1">&#39;dim&#39;</span><span class="p">))</span>
    <span class="n">ReSigmaR2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">ReSigmaR</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="n">ReSigmaR2</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;eV&#39;</span>
    <span class="n">ReSigmaR</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ImSigmaR</span> <span class="o">=</span> <span class="n">PC</span><span class="o">.</span><span class="n">Rydberg2eV</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">infile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;ImSigmaR&#39;</span><span class="p">][:])</span>
    <span class="n">ImSigmaR2</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;ImSigmaR&#39;</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;dim&#39;</span><span class="p">,</span> <span class="s1">&#39;dim&#39;</span><span class="p">))</span>
    <span class="n">ImSigmaR2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">ImSigmaR</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="n">ImSigmaR2</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;eV&#39;</span>
    <span class="n">ImSigmaR</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Close files</span>
    <span class="n">infile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">outfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="CheckIfFinished"><a class="viewcode-back" href="../../api-gen/Inelastica.SetupRuns.html#Inelastica.SetupRuns.CheckIfFinished">[docs]</a><span class="k">def</span> <span class="nf">CheckIfFinished</span><span class="p">(</span><span class="n">outfile</span><span class="p">):</span>
    <span class="k">print</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span> <span class="k">pass</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&gt;&gt; End&#39;</span> <span class="ow">or</span> <span class="n">line</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;======&#39;</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;CheckIfFinished: </span><span class="si">%s</span><span class="s1"> is done.&#39;</span><span class="o">%</span><span class="n">outfile</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;CheckIfFinished: </span><span class="si">%s</span><span class="s1"> is NOT done.&#39;</span><span class="o">%</span><span class="n">outfile</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;CheckIfFinished: </span><span class="si">%s</span><span class="s1"> does NOT exist!&#39;</span><span class="o">%</span><span class="n">outfile</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span></div>


<div class="viewcode-block" id="FindElectrodeSep"><a class="viewcode-back" href="../../api-gen/Inelastica.SetupRuns.html#Inelastica.SetupRuns.FindElectrodeSep">[docs]</a><span class="k">def</span> <span class="nf">FindElectrodeSep</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">AtomsPerLayer</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">xvfile</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">directory</span><span class="o">+</span><span class="s1">&#39;/*.XV*&#39;</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">xvfile</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">MG</span><span class="o">.</span><span class="n">Geom</span><span class="p">(</span><span class="n">xvfile</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">findContactsAndDevice</span><span class="p">(</span><span class="n">AtomsPerLayer</span><span class="p">)</span>
        <span class="n">DeviceFirst</span><span class="p">,</span> <span class="n">DeviceLast</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">deviceList</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">g</span><span class="o">.</span><span class="n">deviceList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">ContactSeparation</span><span class="p">,</span> <span class="n">DeviceFirst</span><span class="p">,</span> <span class="n">DeviceLast</span></div>


<div class="viewcode-block" id="MakePBS"><a class="viewcode-back" href="../../api-gen/Inelastica.SetupRuns.html#Inelastica.SetupRuns.MakePBS">[docs]</a><span class="k">def</span> <span class="nf">MakePBS</span><span class="p">(</span><span class="n">PBStemplate</span><span class="p">,</span> <span class="n">PBSout</span><span class="p">,</span> <span class="n">PBSsubs</span><span class="p">,</span> <span class="n">submitJob</span><span class="p">,</span> <span class="n">rtype</span><span class="o">=</span><span class="s1">&#39;TS&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">PBStemplate</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">rtypes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;TS&#39;</span><span class="p">:</span> <span class="s1">&#39;RUN.TS.pbs&#39;</span><span class="p">,</span> <span class="s1">&#39;OS&#39;</span><span class="p">:</span> <span class="s1">&#39;RUN.OS.pbs&#39;</span><span class="p">,</span> <span class="s1">&#39;PY&#39;</span><span class="p">:</span> <span class="s1">&#39;RUN.py.pbs&#39;</span><span class="p">}</span>
        <span class="n">PBStemplate</span> <span class="o">=</span> <span class="n">rtypes</span><span class="p">[</span><span class="n">rtype</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~/.Inelastica/&#39;</span><span class="o">+</span><span class="n">PBStemplate</span><span class="p">)):</span>
            <span class="n">PBStemplate</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~/.Inelastica/&#39;</span><span class="o">+</span><span class="n">PBStemplate</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">InelasticaDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">PBStemplate</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">InelasticaDir</span><span class="o">+</span><span class="s1">&#39;/PBS/&#39;</span><span class="o">+</span><span class="n">PBStemplate</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">PBStemplate</span><span class="p">):</span>
        <span class="n">WritePBS</span><span class="p">(</span><span class="n">PBStemplate</span><span class="p">,</span> <span class="n">PBSout</span><span class="p">,</span> <span class="n">PBSsubs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">submitJob</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">PBStemplate</span><span class="p">)</span>
            <span class="n">workingFolder</span><span class="p">,</span> <span class="n">PBSfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">PBSout</span><span class="p">))</span>
            <span class="n">SubmitPBS</span><span class="p">(</span><span class="n">workingFolder</span><span class="p">,</span> <span class="n">PBSfile</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;WARNING: Could not find PBS template file&quot;</span><span class="p">,</span> <span class="n">PBStemplate</span><span class="p">)</span></div>


<div class="viewcode-block" id="WritePBS"><a class="viewcode-back" href="../../api-gen/Inelastica.SetupRuns.html#Inelastica.SetupRuns.WritePBS">[docs]</a><span class="k">def</span> <span class="nf">WritePBS</span><span class="p">(</span><span class="n">PBStemplate</span><span class="p">,</span> <span class="n">PBSout</span><span class="p">,</span> <span class="n">PBSsubs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;SetupRuns.WritePBS: Reading&#39;</span><span class="p">,</span> <span class="n">PBStemplate</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;SetupRuns.WritePBS: Writing&#39;</span><span class="p">,</span> <span class="n">PBSout</span><span class="p">)</span>

    <span class="c1"># Make default job name</span>
    <span class="n">fullPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">PBSout</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">last2dir</span> <span class="o">=</span> <span class="n">fullPath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="k">try</span><span class="p">:</span> <span class="c1"># Check for numbers at start ... not liked by PBS</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">last2dir</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">last2dir</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">+</span><span class="n">last2dir</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">PBSsubs</span><span class="p">:</span> <span class="n">PBSsubs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">newPBSsub</span> <span class="o">=</span> <span class="n">PBSsubs</span><span class="o">+</span><span class="p">[[</span><span class="s1">&#39;$DEFJOBNAME$&#39;</span><span class="p">,</span> <span class="n">last2dir</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="n">last2dir</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>
    <span class="n">infile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">PBStemplate</span><span class="p">)</span>
    <span class="n">outfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">PBSout</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">infile</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">newPBSsub</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">infile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">outfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="SubmitPBS"><a class="viewcode-back" href="../../api-gen/Inelastica.SetupRuns.html#Inelastica.SetupRuns.SubmitPBS">[docs]</a><span class="k">def</span> <span class="nf">SubmitPBS</span><span class="p">(</span><span class="n">workingfolder</span><span class="p">,</span> <span class="n">pbsfile</span><span class="p">):</span>
    <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">workingfolder</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;qsub &#39;</span><span class="o">+</span><span class="n">pbsfile</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;   ...and submitted!!!&#39;</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2003-2018, Magnus Paulsson and Thomas Frederiksen.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'v1.3.6',
            LANGUAGE:'en',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>